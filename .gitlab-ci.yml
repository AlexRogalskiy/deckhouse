stages:
  - build
  - cleanup

Build:
  stage: build
  script:
    - source /etc/profile.d/rvm.sh
    - dapp --version
    - dapp dimg stages cleanup local --build-dir ~/dapp_build/${CI_PROJECT_NAME} --improper-git-commit
    - dapp dimg build --build-dir ~/dapp_build/${CI_PROJECT_NAME}
    - dapp dimg push --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE} --tag-ci --verbose
  tags:
    - build

Cleanup dapp dimg stages:
  stage: cleanup
  script:
    - source /etc/profile.d/rvm.sh
    - dapp --version
    - dapp dimg stages cleanup local --build-dir ~/dapp_build/${CI_PROJECT_NAME} --improper-git-commit --improper-repo-cache ${CI_REGISTRY_IMAGE}
  only:
    - branches
  tags:
    - build
