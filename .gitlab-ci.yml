.base_deploy: &base_deploy
  stage: deploy
  script:
    - dapp kube deploy
      --image-version ${CI_COMMIT_REF_NAME}
      --namespace ${CI_PROJECT_NAME}-${CI_ENVIRONMENT_SLUG}
      --set global.env=${CI_ENVIRONMENT_SLUG}
      $CI_REGISTRY_IMAGE
  dependencies:
    - Build
  tags:
    - deploy

stages:
  - build
  - deploy
  - cleanup

Build:
  stage: build
  script:
    - source /etc/profile.d/rvm.sh
    - dapp --version
    - dapp dimg stages cleanup local --build-dir ~/dapp_build/${CI_PROJECT_NAME} --improper-git-commit
    - dapp dimg build --build-dir ~/dapp_build/${CI_PROJECT_NAME}
    - dapp dimg push --build-dir ~/dapp_build/${CI_PROJECT_NAME} ${CI_REGISTRY_IMAGE} --tag-ci --verbose
  tags:
    - build

Deploy to Stage:
  <<: *base_deploy
  environment:
    name: stage
    url: http://antiopa.stage.flant.com
  only:
    - branches
  when: manual


Deploy to Test:
  <<: *base_deploy
  environment:
    name: test
    url: http://antiopa.test.flant.com
  only:
    - branches
  when: manual

Deploy to Production:
  <<: *base_deploy
  environment:
    name: production
    url: http://antiopa.flant.com
  only:
    - master
  when: manual

Cleanup dapp dimg stages:
  stage: cleanup
  script:
    - source /etc/profile.d/rvm.sh
    - dapp --version
    - dapp dimg stages cleanup local --build-dir ~/dapp_build/${CI_PROJECT_NAME} --improper-git-commit --improper-repo-cache ${CI_REGISTRY_IMAGE}
  only:
    - branches
  tags:
    - build
