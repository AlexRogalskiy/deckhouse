include:
  - '.gitlab/ci_includes/web.yml'
  - '.gitlab/ci_includes/terraform_versions.yml'
  - '.gitlab/ci_templates/build.yml'
  - '.gitlab/ci_templates/cleanup.yml'
  - '.gitlab/ci_templates/tests.yml'
  - '.gitlab/ci_templates/deploy.yml'

variables:
  # Don't forget to update .gitlab-ci-simple.yml if necessary
  WERF_VERBOSE: "1"
  WERF_STAGES_REPO_BASE: ${REGISTRY_STAGES_HOST}
  WERF_STAGES_STORAGE_REPO_IMPLEMENTATION: default
  STAGES_STORAGE_LOGIN_CMD: "docker login -u ${REGISTRY_STAGES_USER} -p ${REGISTRY_STAGES_PASSWORD} ${WERF_STAGES_REPO_BASE}"
  BASE_ALPINE: "alpine:3.12.1"
  BASE_DEBIAN: "debian:buster"
  BASE_GOLANG_ALPINE: "golang:1.15.3-alpine3.12"
  BASE_GOLANG_BUSTER: "golang:1.15.3-buster"
  BASE_NGINX_ALPINE: "nginx:1.15-alpine"
  BASE_PYTHON_ALPINE: "python:3.7.9-alpine3.12"
  BASE_SHELL_OPERATOR: "flant/shell-operator:v1.0.0-beta.12-alpine3.11"
  BASE_UBUNTU: "ubuntu:18.04"

stages:
  - build_modules_images
  - build
  - testing
  - deploy
  - deploy_website
  - cleanup_registry
  - cleanup_builder

Build Modules Images:
  extends: .Build Modules Images template
  tags:
  - werf-distributed

Build:
  extends: .Build template
  tags:
    - werf-distributed

Tests:
  extends: .Tests template
  tags:
    - werf-distributed

Matrix Tests:
  extends: .Matrix Tests template
  tags:
    - werf-distributed

Candictl Tests:
  extends: .Candictl Tests template
  tags:
    - werf-distributed

GolangCI Lint:
  extends: .GolangCI Lint template
  tags:
    - werf-distributed

Cloud layouts Tests (manual):
  extends: .Cloud layouts Tests template
  tags:
    - cloud-layouts
  except:
    variables:
    - $CLOUD_LAYOUTS_SCHEDULE
    refs:
    - alpha
    - beta
    - early-access
    - stable
    - rock-solid
  when: manual

Cloud layouts Tests vSphere (manual):
  extends: .Cloud layouts Tests vSphere template
  tags:
    - cloud-layouts-vsphere
  except:
    variables:
    - $CLOUD_LAYOUTS_SCHEDULE
    refs:
    - alpha
    - beta
    - early-access
    - stable
    - rock-solid
  when: manual

Cloud layouts Tests (scheduled):
  extends: .Cloud layouts Tests template
  tags:
    - cloud-layouts
  only:
    variables:
    - $CLOUD_LAYOUTS_SCHEDULE
  when: always

Cloud layouts Tests vSphere (scheduled):
  extends: .Cloud layouts Tests vSphere template
  tags:
    - cloud-layouts-vsphere
  only:
    variables:
    - $CLOUD_LAYOUTS_SCHEDULE
  when: always

Hooks Configuration Tests:
  extends: .Hooks Configuration Tests template
  tags:
    - werf-distributed

No Cyrillic Validation:
  extends: .No Cyrillic Validation template
  tags:
    - werf-distributed

.base_deploy: &base_deploy
  extends: .base_deploy_template
  after_script:
    - docker image rmi $DESTINATION_IMAGE
    - docker image rmi $DESTINATION_INSTALL_IMAGE
    - git checkout ${CI_JOB_NAME} && git reset ${CI_COMMIT_SHA}
    - git push --force $(echo ${CI_REPOSITORY_URL} | sed -r "s/^(.+gitlab-ci-token:).+(\@.+)$/\1${REGISTRY_CLEANER_TOKEN}\2/") ${CI_JOB_NAME}
  needs:
    - "Matrix Tests"
    - "Hooks Configuration Tests"
    - "Tests"
    - "Build"
    - "Build Modules Images"
  tags:
    - werf-distributed

alpha:
  <<: *base_deploy
  environment:
    name: alpha
  only:
    - tags
    - master
    - /^release-.*$/

beta:
  <<: *base_deploy
  environment:
    name: beta
  only:
    - tags

early-access:
  <<: *base_deploy
  environment:
    name: early-access
  only:
    - tags

stable:
  <<: *base_deploy
  environment:
    name: stable
  only:
    - tags

rock-solid:
  <<: *base_deploy
  environment:
    name: rock-solid
  only:
    - tags

Cleanup registry:
  extends: .Cleanup registry template
  tags:
    - werf-distributed
  retry: 2

Cleanup modules registry:
  extends: .Cleanup modules registry template
  tags:
    - werf-distributed
  retry: 2

Cleanup modules images:
  extends: .Cleanup modules images template
  tags:
    - werf-distributed
