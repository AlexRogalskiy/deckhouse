stages:
  - build
  - deploy
  - cleanup

Build:
  stage: build
  script:
    - ./modules_images bp --write-tags=modules/images_tags.yaml
    - source dapp_use 0.27
    - dapp --version
    - dapp dimg bp --tag-ci --verbose ${CI_REGISTRY_IMAGE}/dev
    - if [[ -n ${CI_COMMIT_TAG} ]]; then dapp dimg push --tag-plain ${CI_COMMIT_TAG} --verbose ${CI_REGISTRY_IMAGE}; fi
  except:
    - schedules
  tags:
    - build

.base_deploy: &base_deploy
  stage: deploy
  script:
    - dapp dimg push ${CI_REGISTRY_IMAGE} --tag ${CI_JOB_NAME}
  when: manual
  tags:
    - build

master:
  <<: *base_deploy
  environment:
    name: master
  only:
    - master
    - tags
  except:
    - schedules

ea:
  <<: *base_deploy
  environment:
    name: ea
  only:
    - tags

stable:
  <<: *base_deploy
  environment:
    name: stable
  only:
    - tags

Cleanup:
  stage: cleanup
  script:
    - source dapp_use 0.27
    - dapp --version
    - dapp dimg cleanup repo ${CI_REGISTRY_IMAGE}/dev --registry-username=registry-cleaner --registry-password=$REGISTRY_CLEANER_TOKEN
    - dapp dimg stages cleanup local
        --improper-cache-version
        --improper-git-commit
        --improper-repo-cache
        ${CI_REGISTRY_IMAGE}/dev
  only:
    - schedules
  tags:
    - build
  retry: 2

Cleanup modules images:
  stage: cleanup
  script:
    - ./modules_images cleanup --registry-user=registry-cleaner --registry-password=$REGISTRY_CLEANER_TOKEN
  only:
    - schedules
  tags:
    - build
