From cc7ecdd8c767060d0c42a98ebc11b5de8e5cdfd5 Mon Sep 17 00:00:00 2001
From: Frederic Branczyk <fbranczyk@gmail.com>
Date: Tue, 3 Apr 2018 11:26:18 +0200
Subject: [PATCH] prometheus: Make relabeling fields optional

---
 Documentation/api.md                                    | 4 ++--
 example/prometheus-operator-crd/prometheus.crd.yaml     | 3 ---
 example/prometheus-operator-crd/servicemonitor.crd.yaml | 3 ---
 pkg/client/monitoring/v1/openapi_generated.go           | 1 -
 pkg/client/monitoring/v1/types.go                       | 4 ++--
 5 files changed, 4 insertions(+), 11 deletions(-)

diff --git a/Documentation/api.md b/Documentation/api.md
index 339baa4e3..cbfda0a25 100644
--- a/Documentation/api.md
+++ b/Documentation/api.md
@@ -245,12 +245,12 @@ RelabelConfig allows dynamic rewriting of the label set, being applied to sample
 
 | Field | Description | Scheme | Required |
 | ----- | ----------- | ------ | -------- |
-| sourceLabels | The source labels select values from existing labels. Their content is concatenated using the configured separator and matched against the configured regular expression for the replace, keep, and drop actions. | []string | true |
+| sourceLabels | The source labels select values from existing labels. Their content is concatenated using the configured separator and matched against the configured regular expression for the replace, keep, and drop actions. | []string | false |
 | separator | Separator placed between concatenated source label values. default is ';'. | string | false |
 | targetLabel | Label to which the resulting value is written in a replace action. It is mandatory for replace actions. Regex capture groups are available. | string | false |
 | regex | Regular expression against which the extracted value is matched. defailt is '(.*)' | string | false |
 | modulus | Modulus to take of the hash of the source label values. | uint64 | false |
-| replacement | Replacement value against which a regex replace is performed if the regular expression matches. Regex capture groups are available. Default is '$1' | string | true |
+| replacement | Replacement value against which a regex replace is performed if the regular expression matches. Regex capture groups are available. Default is '$1' | string | false |
 | action | Action to perform based on regex matching. Default is 'replace' | string | false |
 
 [Back to TOC](#table-of-contents)
diff --git a/example/prometheus-operator-crd/prometheus.crd.yaml b/example/prometheus-operator-crd/prometheus.crd.yaml
index 4a1fde5d5..e4c43f60a 100644
--- a/example/prometheus-operator-crd/prometheus.crd.yaml
+++ b/example/prometheus-operator-crd/prometheus.crd.yaml
@@ -1832,9 +1832,6 @@ spec:
                             in a replace action. It is mandatory for replace actions.
                             Regex capture groups are available.
                           type: string
-                      required:
-                      - sourceLabels
-                      - replacement
                     type: array
                 required:
                 - url
diff --git a/example/prometheus-operator-crd/servicemonitor.crd.yaml b/example/prometheus-operator-crd/servicemonitor.crd.yaml
index 72acb06ff..c83818f9c 100644
--- a/example/prometheus-operator-crd/servicemonitor.crd.yaml
+++ b/example/prometheus-operator-crd/servicemonitor.crd.yaml
@@ -123,9 +123,6 @@ spec:
                             in a replace action. It is mandatory for replace actions.
                             Regex capture groups are available.
                           type: string
-                      required:
-                      - sourceLabels
-                      - replacement
                     type: array
                   params:
                     description: Optional HTTP URL parameters
diff --git a/pkg/client/monitoring/v1/openapi_generated.go b/pkg/client/monitoring/v1/openapi_generated.go
index ff150829a..4131f674b 100644
--- a/pkg/client/monitoring/v1/openapi_generated.go
+++ b/pkg/client/monitoring/v1/openapi_generated.go
@@ -1010,7 +1010,6 @@ func GetOpenAPIDefinitions(ref common.ReferenceCallback) map[string]common.OpenA
 							},
 						},
 					},
-					Required: []string{"sourceLabels", "replacement"},
 				},
 			},
 			Dependencies: []string{},
diff --git a/pkg/client/monitoring/v1/types.go b/pkg/client/monitoring/v1/types.go
index f5e815029..659e0a91c 100644
--- a/pkg/client/monitoring/v1/types.go
+++ b/pkg/client/monitoring/v1/types.go
@@ -238,7 +238,7 @@ type RelabelConfig struct {
 	//The source labels select values from existing labels. Their content is concatenated
 	//using the configured separator and matched against the configured regular expression
 	//for the replace, keep, and drop actions.
-	SourceLabels []string `json:"sourceLabels"`
+	SourceLabels []string `json:"sourceLabels,omitempty"`
 	//Separator placed between concatenated source label values. default is ';'.
 	Separator string `json:"separator,omitempty"`
 	//Label to which the resulting value is written in a replace action.
@@ -250,7 +250,7 @@ type RelabelConfig struct {
 	Modulus uint64 `json:"modulus,omitempty"`
 	//Replacement value against which a regex replace is performed if the
 	//regular expression matches. Regex capture groups are available. Default is '$1'
-	Replacement string `json:"replacement"`
+	Replacement string `json:"replacement,omitempty"`
 	// Action to perform based on regex matching. Default is 'replace'
 	Action string `json:"action,omitempty"`
 }
