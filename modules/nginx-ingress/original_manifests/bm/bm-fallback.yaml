apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: bm-fallback
  namespace: kube-nginx-ingress
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: "..."
spec:
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: bm-fallback
#TODO: Docker before 1.12 does not support sysctls
#      annotations:
#        security.alpha.kubernetes.io/sysctls: "net.ipv4.ip_local_port_range=1024 65000"
    spec:
      nodeSelector:
        node-role/frontend: ""
      tolerations:
      - key: node-role/frontend
        operator: Exists
        effect: NoExecute
      serviceAccount: kube-nginx-ingress
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - image: flant/kubernetes-nginx-ingress-bm-fallback:v0.1.0
        name: nginx
        imagePullPolicy: Always
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10253
            host: 127.0.0.1
          initialDelaySeconds: 3
      - image: flant/kubernetes-nginx-ingress-bm-fallback-iptables:v0.1.0
        name: iptables-loop
        imagePullPolicy: Always
        securityContext:
          capabilities:
            add:
            - NET_RAW
            - NET_ADMIN
      - name: bmlb-exporter
        image: flant/nginx_exporter:v1.0
        args: ["-nginx.scrape_uri=http://127.0.0.1:10253/nginx_status", "-telemetry.address=127.0.0.1:10354", "-insecure=true"]
        livenessProbe:
          httpGet:
            path: /metrics
            port: 10354
            host: 127.0.0.1
