{{- range (prepend .Values.nginxIngress.additionalControllers .Values.nginxIngress) }}
  {{- $_ := set . "Values" $.Values }}
  {{- $inlet := (include "helper.inlet" .) }}
  {{- if eq $inlet "Direct" }}
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-for-direct-fallback
  namespace: {{ include "helper.namespace" . }}
  labels:
    heritage: antiopa
    module: {{ $.Chart.Name }}
    app: nginx-for-direct-fallback
spec:
  ports:
  - name: http-proxy
    port: 80
    protocol: TCP
  - name: https-proxy
    port: 443
    protocol: TCP
  selector:
    app: nginx-for-direct-fallback
---
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: direct-fallback
  namespace: {{ include "helper.namespace" . }}
  labels:
    heritage: antiopa
    module: {{ $.Chart.Name }}
    app: nginx-for-direct-fallback
spec:
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: direct-fallback
  template:
    metadata:
      labels:
        app: direct-fallback
#TODO: Docker before 1.12 does not support sysctls
#      annotations:
#        security.alpha.kubernetes.io/sysctls: "net.ipv4.ip_local_port_range=1024 65000"
    spec:
{{ include "helper.nodeSelector" . | indent 6 }}
{{ include "helper.tolerations" . | indent 6 }}
      serviceAccount: kube-nginx-ingress
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      terminationGracePeriodSeconds: 300
      containers:
      - image: {{ $.Values.global.modulesImages.registry }}/nginx-ingress/direct-fallback:{{ $.Values.global.modulesImages.tags.nginxIngress.directFallback }}
        name: nginx
        imagePullPolicy: Always
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10253
            host: 127.0.0.1
          initialDelaySeconds: 3
        lifecycle:
          preStop:
            exec:
              command: ["/usr/sbin/nginx","-s","quit"]
      - image: {{ $.Values.global.modulesImages.registry }}/nginx-ingress/direct-fallback-iptables:{{ $.Values.global.modulesImages.tags.nginxIngress.directFallbackIptables }}
        name: iptables-loop
        imagePullPolicy: Always
        securityContext:
          capabilities:
            add:
            - NET_RAW
            - NET_ADMIN
      - name: bmlb-exporter
        image: {{ $.Values.global.modulesImages.registry }}/nginx-ingress/nginx-exporter:{{ $.Values.global.modulesImages.tags.nginxIngress.nginxExporter }}
        args: ["-nginx.scrape_uri=http://127.0.0.1:10253/nginx_status", "-telemetry.address=127.0.0.1:10354", "-insecure=true"]
        livenessProbe:
          httpGet:
            path: /metrics
            port: 10354
            host: 127.0.0.1
      imagePullSecrets:
      - name: registry
  {{- end }}
{{- end }}
