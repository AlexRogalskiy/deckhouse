#!/usr/bin/env bash
set -Eeuo pipefail
shopt -s inherit_errexit
shopt -s failglob

find_rm_ignore=""

# В цикле запускаем пингалку с нужными параметрами и отправляем в фон на вечное исполнение
while [[ $# -ge 2 ]] ; do
  if [[ "$1" != "$MY_NODE_NAME" ]] ; then
    node-ping-pinger $1 $2 &
    find_rm_ignore=${find_rm_ignore}" -not -name ${PROMETHEUS_TEXTFILE_PREFIX}${1}.prom -not -name ${PROMETHEUS_TEXTFILE_PREFIX}${1}.tmp"
  fi
  shift 2
done

# Чистим hostPath каталоги от старых экспорт-файлов
find ${PROMETHEUS_TEXTFILE_DIR} -type f ${find_rm_ignore} -name "${PROMETHEUS_TEXTFILE_PREFIX}*.prom" -name "${PROMETHEUS_TEXTFILE_PREFIX}*.tmp" -delete 
# Делаем wait, чтобы вечно ждать завершения форков
wait
