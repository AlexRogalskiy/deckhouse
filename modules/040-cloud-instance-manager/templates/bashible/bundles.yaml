{{- $cloud_provider_bashible_bundles_pattern := "" }}
{{- if hasKey $.Values.cloudInstanceManager.internal "cloudProvider" }}
  {{- $cloud_provider_bashible_bundles_pattern = printf "{,cloud-providers/%s/}" $.Values.cloudInstanceManager.internal.cloudProvider.type }}
{{- end }}

{{- $bashible_bundles := list "ubuntu-18.04" "centos-7" }}
{{- range $bashible_bundle := $bashible_bundles }}
  {{- range $ng := $.Values.cloudInstanceManager.internal.nodeGroups }}
    {{- $tpl_context := dict }}
    {{- $_ := set $tpl_context "Release" $.Release }}
    {{- $_ := set $tpl_context "Chart" $.Chart }}
    {{- $_ := set $tpl_context "Files" $.Files }}
    {{- $_ := set $tpl_context "Capabilities" $.Capabilities }}
    {{- $_ := set $tpl_context "Template" $.Template }}
    {{- $_ := set $tpl_context "Values" $.Values }}
    {{- $_ := set $tpl_context "bashibleBundle" $bashible_bundle }}
    {{- $_ := set $tpl_context "nodeGroup" $ng }}
---
apiVersion: v1
kind: Secret
metadata:
  name: bashible-bundle-{{ $bashible_bundle }}-{{ $ng.name }}
  namespace: d8-{{ $.Chart.Name }}
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
type: Opaque
data:
    {{- range $step_file, $_ := $.Files.Glob (printf "%sbashible-bundles/{%s,common}/node-group/*" $cloud_provider_bashible_bundles_pattern $bashible_bundle) }}
{{ base $step_file | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}
  {{- end }}

  {{- $tpl_context := dict }}
  {{- $_ := set $tpl_context "Release" $.Release }}
  {{- $_ := set $tpl_context "Chart" $.Chart }}
  {{- $_ := set $tpl_context "Files" $.Files }}
  {{- $_ := set $tpl_context "Capabilities" $.Capabilities }}
  {{- $_ := set $tpl_context "Template" $.Template }}
  {{- $_ := set $tpl_context "Values" $.Values }}
  {{- $_ := set $tpl_context "bashibleBundle" $bashible_bundle }}
---
apiVersion: v1
kind: Secret
metadata:
  name: bashible-bundle-{{ $bashible_bundle }}
  namespace: d8-{{ $.Chart.Name }}
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
type: Opaque
data:
  {{- range $step_file, $_ := $.Files.Glob (printf "%sbashible-bundles/{%s,common}/all/*" $cloud_provider_bashible_bundles_pattern $bashible_bundle) }}
{{ base $step_file | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
  {{- end }}
{{- end }}
