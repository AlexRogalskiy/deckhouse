{{- $patterns_steps_common := list  }}
{{- $patterns_steps_common = append $patterns_steps_common "candi/bashible/common-steps/%s/*.sh.tpl" }}

{{- $patterns_steps_os_related := list  }}
{{- $patterns_steps_os_related = append $patterns_steps_os_related "candi/bashible/bundles/%s/%s/*.sh.tpl" }}

{{- if hasKey $.Values.cloudInstanceManager.internal "cloudProvider" }}
  {{- $patterns_steps_os_related = append $patterns_steps_os_related (list "candi/cloud-providers/" $.Values.cloudInstanceManager.internal.cloudProvider.type "/bashible-bundles/%s/%s/*.sh.tpl" | join "") }}
{{- end }}

{{- range $bundle := list "ubuntu-18.04" "centos-7" }}
  {{- range $ng := $.Values.cloudInstanceManager.internal.nodeGroups }}
    {{- $normal := dict }}
    {{- $_ := set $normal "bootstrapTokenPath" "/var/lib/bashible/bootstrap-token" }}
    {{- $_ := set $normal "apiserverEndpoints" $.Values.cloudInstanceManager.internal.clusterMasterAddresses }}
    {{- $_ := set $normal "clusterDomain" $.Values.global.discovery.clusterDomain }}
    {{- $_ := set $normal "clusterDNSAddress" $.Values.global.discovery.clusterDNSAddress }}
    {{- $_ := set $normal "kubernetesCA" $.Values.cloudInstanceManager.internal.kubernetesCA }}

    {{- $tpl_context := dict }}
    {{- $_ := set $tpl_context "runType" "Normal" }}
    {{- $_ := set $tpl_context "bundle" $bundle }}
    {{- $_ := set $tpl_context "kubernetesVersion" $ng.kubernetesVersion }}
    {{- $_ := set $tpl_context "normal" $normal }}
    {{- $_ := set $tpl_context "nodeGroup" $ng }}
    {{- $_ := set $tpl_context "Template" $.Template }}
---
apiVersion: v1
kind: Secret
metadata:
  name: bashible-bundle-{{ $bundle }}-{{ $ng.name }}
  namespace: d8-{{ $.Chart.Name }}
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
type: Opaque
data:
    {{- $patterns_rendered := list }}
    {{- range $pattern := $patterns_steps_os_related }}
      {{- $patterns_rendered = append $patterns_rendered (printf $pattern $bundle "node-group") }}
    {{- end }}
    {{- range $pattern := $patterns_steps_common }}
      {{- $patterns_rendered = append $patterns_rendered (printf $pattern "node-group") }}
    {{- end }}
    {{- range $step_file, $_ := $.Files.Glob (printf "{%s}" ($patterns_rendered | join ",")) }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}
  {{- end }}

  {{- range $kubernetes_version := list "1.14" "1.15" "1.16" }}
    {{- $normal := dict }}
    {{- $_ := set $normal "bootstrapTokenPath" "/var/lib/bashible/bootstrap-token" }}
    {{- $_ := set $normal "apiserverEndpoints" $.Values.cloudInstanceManager.internal.clusterMasterAddresses }}
    {{- $_ := set $normal "clusterDomain" $.Values.global.discovery.clusterDomain }}
    {{- $_ := set $normal "clusterDNSAddress" $.Values.global.discovery.clusterDNSAddress }}
    {{- $_ := set $normal "kubernetesCA" $.Values.cloudInstanceManager.internal.kubernetesCA }}

    {{- $tpl_context := dict }}
    {{- $_ := set $tpl_context "runType" "Normal" }}
    {{- $_ := set $tpl_context "bundle" $bundle }}
    {{- $_ := set $tpl_context "kubernetesVersion" $kubernetes_version }}
    {{- $_ := set $tpl_context "normal" $normal }}
    {{- $_ := set $tpl_context "Template" $.Template }}
---
apiVersion: v1
kind: Secret
metadata:
  name: bashible-bundle-{{ $bundle }}-{{ $kubernetes_version }}
  namespace: d8-{{ $.Chart.Name }}
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
type: Opaque
data:
    {{- $patterns_rendered := list }}
    {{- range $pattern := $patterns_steps_os_related }}
      {{- $patterns_rendered = append $patterns_rendered (printf $pattern $bundle "all") }}
    {{- end }}
    {{- range $pattern := $patterns_steps_common }}
      {{- $patterns_rendered = append $patterns_rendered (printf $pattern "all") }}
    {{- end }}
    {{- range $step_file, $_ := $.Files.Glob (printf "{%s}" ($patterns_rendered | join ",")) }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}
  {{- end }}
{{- end }}
