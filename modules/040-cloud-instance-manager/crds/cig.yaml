apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: cloudinstancegroups.deckhouse.io
  labels:
    heritage: deckhouse
    module: cloud-instance-manager
spec:
  group: deckhouse.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: cloudinstancegroups
    singular: cloudinstancegroup
    kind: CloudInstanceGroup
    shortNames:
    - cig
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: integer
    description: "Number of ready Kubernetes nodes in the group."
    JSONPath: .status.ready
  - name: Nodes
    type: integer
    description: "Number of Kubernetes nodes (in any state) in the group."
    JSONPath: .status.nodes
  - name: Machines
    type: integer
    description: "Number of machines (in any state) in the group."
    JSONPath: .status.machines
  - name: Desired
    type: integer
    description: "Number of desired machines in the group."
    JSONPath: .status.desired
  - name: Min
    type: integer
    description: "Minimal amount of instances in InstanceGroup."
    JSONPath: .status.min
  - name: Max
    type: integer
    description: "Maximum amount of instances in InstanceGroup."
    JSONPath: .status.max
  - name: Error
    type: string
    description: "Error message about possible problems with handling CIG by module d8-cloud-instance-manager."
    JSONPath: .status.error
  validation:
    openAPIV3Schema:
      type: object
      description: 'CloudInstanceGroup defines runtime parameters for a group of Instances'
      required:
      - spec
      properties:
        status:
          type: object
          required: []
          properties:
            ready:
              type: integer
              description: "Number of ready Kubernetes nodes in the group."
            nodes:
              type: integer
              description: "Number of machines (in any state) in the group."
            machines:
              type: integer
              description: "Number of Kubernetes nodes (in any state) in the group."
            desired:
              type: integer
              description: "Number of desired machines in the group."
            min:
              type: integer
              description: "Minimal amount of instances in InstanceGroup."
            max:
              type: integer
              description: "Maximum amount of instances in InstanceGroup."
            error:
              type: string
              description: "Error message about possible problems with handling CIG by module d8-cloud-instance-manager."
        spec:
          type: object
          required:
          - instanceClassReference
          - minInstancesPerZone
          - maxInstancesPerZone
          properties:
            zones:
              description: List of availability zones to create instances in.
              example: |
                - Helsinki
                - Espoo
                - Tampere
              type: array
              items:
                type: string
            instanceClassReference:
              description: Reference to a cloud-provider specific InstanceClass object
              example: |
                kind: OpenStackInstanceClass
                name: finland-medium
              type: object
              properties:
                kind:
                  type: string
                  enum:
                  - OpenStackInstanceClass
                  - GCPInstanceClass
                  - VsphereInstanceClass
                  - AWSInstanceClass
                  - YandexInstanceClass
                name:
                  type: string
            minInstancesPerZone:
              description: |
                Minimal amount of instances in InstanceGroup in each zone.
                If equals-or-more than "maxInstancesPerZone", cluster-autoscaler is disabled for this InstanceGroup.
              type: integer
              minimum: 0
            maxInstancesPerZone:
              description: |
                Maximum amount of instances in InstanceGroup in each zone.
              type: integer
              minimum: 0
            maxInstancesUnavailablePerZone:
              description: |
                Maximum amount of unavailable instances (during rollout) in InstanceGroup in each zone.
              type: integer
              minimum: 0
            maxInstancesSurgePerZone:
              description: |
                Maximum amount of instances to rollout simultaneously in InstanceGroup in each zone.
              type: integer
              minimum: 0
            chaos:
              description: Chaos monkey settings
              example: |
                mode: DrainAndDelete
                period: 24h
              type: object
              properties:
                mode:
                  type: string
                  enum:
                  - DrainAndDelete
                  - Disabled
                period:
                  type: string
                  pattern: '^[0-9]+[mh]{1}$'
            nodeTemplate:
              description: Specification of some of the fields that will be applied to a Kubernetes node object once it joins the cluster.
              example: |
                labels:
                  environment: production
                  app: warp-drive-ai
                annotations:
                  ai.fleet.com/discombobulate: "true"
                taints:
                - effect: NoExecute
                  key: ship-class
                  value: frigate
              type: object
              properties:
                labels:
                  type: object
                  additionalProperties:
                    type: string
                annotations:
                  type: object
                  additionalProperties:
                    type: string
                taints:
                  type: array
                  items:
                    type: object
                    properties:
                      effect:
                        type: string
                        enum:
                        - NoSchedule
                        - PreferNoSchedule
                        - NoExecute
                      key:
                        type: string
                      value:
                        type: string
