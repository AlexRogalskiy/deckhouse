apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: cloudinstancegroups.deckhouse.io
  labels:
    heritage: deckhouse
    module: cloud-instance-manager
spec:
  group: deckhouse.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
  scope: Cluster
  names:
    plural: cloudinstancegroups
    singular: cloudinstancegroup
    kind: CloudInstanceGroup
    shortNames:
    - cig
  validation:
    openAPIV3Schema:
      type: object
      description: 'CloudInstanceGroup defines runtime parameters for a group of Instances'
      required:
      - spec
      properties:
        spec:
          type: object
          required:
          - instanceClassReference
          - minInstancesPerZone
          - maxInstancesPerZone
          properties:
            zones:
              description: List of availability zones to create instances in.
              example: |
                - Helsinki
                - Espoo
                - Tampere
              type: array
              items:
                type: string
            instanceClassReference:
              description: Reference to a cloud-provider specific InstanceClass object
              example: |
                kind: OpenStackInstanceClass
                name: finland-medium
              type: object
              properties:
                kind:
                  type: string
                  enum:
                  - OpenStackInstanceClass
                  - GCPInstanceClass
                name:
                  type: string
            minInstancesPerZone:
              description: |
                Minimal amount of instances in InstanceGroup in each zone.
                If equals-or-more than "maxInstancesPerZone", cluster-autoscaler is disabled for this InstanceGroup.
              type: integer
              minimum: 0
            maxInstancesPerZone:
              description: |
                Maximum amount of instances in InstanceGroup in each zone.
              type: integer
              minimum: 0
            maxInstancesUnavailablePerZone:
              description: |
                Maximum amount of unavailable instances (during rollout) in InstanceGroup in each zone.
              type: integer
              minimum: 0
            maxInstancesSurgePerZone:
              description: |
                Maximum amount of instances to rollout simultaneously in InstanceGroup in each zone.
              type: integer
              minimum: 0
            nodeTemplate:
              description: Specification of some of the fields that will be applied to a Kubernetes node object once it joins the cluster.
              example: |
                labels:
                  environment: production
                  app: warp-drive-ai
                annotations:
                  ai.fleet.com/discombobulate: "true"
                taints:
                - effect: NoExecute
                  key: ship-class
                  value: frigate
              type: object
              properties:
                labels:
                  type: object
                  additionalProperties:
                    type: string
                annotations:
                  type: object
                  additionalProperties:
                    type: string
                taints:
                  type: array
                  items:
                    type: object
                    properties:
                      effect:
                        type: string
                        enum:
                        - NoSchedule
                        - PreferNoSchedule
                        - NoExecute
                      key:
                        type: string
                      value:
                        type: string
