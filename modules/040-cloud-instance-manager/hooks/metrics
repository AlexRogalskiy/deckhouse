#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    kubernetes:
    - name: machine_deployments
      apiVersion: machine.sapcloud.io/v1alpha1
      kind: MachineDeployment
      includeSnapshotsFrom: ["machine_deployments"]
      namespace:
        nameSelector:
          matchNames: [d8-cloud-instance-manager]
      labelSelector:
        matchExpressions:
        - key: heritage
          operator: In
          values: ["deckhouse"]
      jqFilter: |
        {
          "name": "machine_deployment_instance_group_info",
          "set": 1,
          "labels":
          {
            "instance_group": .metadata.labels | to_entries[] | select(.key == "instance-group") | .value,
            "name": .metadata.name
          }
        }
EOF
}


function __main__() {
  for i in $(context::jq -r '.snapshots.machine_deployments | keys[]'); do
    context::get snapshots.machine_deployments.$i.filterResult | jq -rc . >> $METRICS_PATH
  done
}

hook::run "$@"
