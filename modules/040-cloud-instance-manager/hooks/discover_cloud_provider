#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    kubernetes:
    - name: cloud_provider_secret
      queue: /modules/$(module::name::kebab_case)
      includeSnapshotsFrom: [cloud_provider_secret]
      apiVersion: v1
      kind: Secret
      namespace:
        nameSelector:
          matchNames: [kube-system]
      nameSelector:
        matchNames: [d8-cloud-instance-manager-cloud-provider]
      jqFilter: |
        (.data | [to_entries[] | (.value |= (. | @base64d))] | from_entries)
        +
        (.data | [to_entries[] | try(.value |= (. | @base64d | fromjson))] | from_entries)
EOF
}

function __on_kubernetes::cloud_provider_secret() {
  if context::has snapshots.cloud_provider_secret.0.filterResult; then
    values::set cloudInstanceManager.internal.cloudProvider "$(context::get snapshots.cloud_provider_secret.0.filterResult)"
  else
    >&2 echo "ERROR: can't find secret kube-system/d8-cloud-instance-manager-cloud-provider, module cloud-provider-xxx didn't run?"
    return 1
  fi
}

hook::run "$@"
