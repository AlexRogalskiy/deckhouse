Модуль OpenVPN
=======

Предназначен для удобного доступа к ресурсам кластера.

Модуль ставит OpenVPN с аутентификацией на основе сертификатов и простой web-интерфейс.

Функции web-интерфейса:
* выпуск сертификатов;
* отзыв сертификатов;
* отмена отзыва сертификатов;
* получение готового пользовательского конфига.

В конфигурации по умолчанию клиентам пушатся:
* адрес kube-dns;
* роут в локальную сеть кластера;
* роут в сервисную сеть;
* роут в сеть подов.

Маршрут по умолчанию у клиентов не переопределяется.

### Параметры:
* `inlet` — способы подключения из внешнего мира.
    * Поддерживаются следующие inlet'ы
      * `ExternalIp` — когда имеются ноды с публичными IP. Используется в комбинации с параметром `externalIp`.
      * `LoadBalancer` — для AWS и gcloud.
      * `Direct` — для не стандартных случаев. В неймспейсе `kube-openvpn` необходимо создать сервис с именем `openvpn-external`, который отправляет трафик в под с лейблом `app: openvpn` на порт с именем `ovpn-tcp` (или просто 1194). Из этого сервиса парсится externalIp, ip балансера или host балансера. Если ничего этого нет, то необходимо указать параметр `externalHost`.
* `externalIp` — IP одной из нод кластера, который будет использоваться для подключения OpenVPN клиентов. Требуется только при использовании инлета `ExternalIp`.
* `externalPort` — порт, который вывешивается наружу на `externalIp` или балансере. По умолчанию задан `5416`.
* `tunnelNetwork` — подсеть используемая для туннеля. Значение по умолчанию `172.25.175.0/255.255.255.0`
* `pushToClientRoutes` — список роутов, которые отправляются клиентам при подключении. Если список пуст, то он сгенерируется автоматически из локальной сети кластера, сервисной подсети и подсети подов.
* `pushToClientDns` — адрес dns-сервера, который отправляется клиентам при подключении. Если параметр не задан, то автоматически будет подставлен IP сервиса kube-system/kube-dns.
* `storageClassName` — имя storageClass'а, который использовать.
    * Если не указано — используется или `global.storageClassName` или `global.discovery.defaultStorageClassName`, а если и они не указаны — данные сохраняются в emptyDir.
    * Если указать `false` — будет форсироваться использование emptyDir'а.
* `password` — пароль для http-авторизации для пользователя `admin` (генерируется автоматически, но можно менять)
    * Используется если не включен модуль `user-authn`.
* `externalHost` — IP или домен по которому клиенты подключаются к OpenVPN серверу. Если не задано, то информация берётся из сервиса с именем `openvpn-external`.
* `certificateForIngress` — выбираем, какой типа сертификата использовать для openvpn admin.
    * `certmanagerClusterIssuerName` — указываем, какой ClusterIssuer использовать для openvpn admin (в данный момент доступны `letsencrypt`, `letsencrypt-staging`, `selfsigned`, но вы можете определить свои).
        * По-умолчанию `letsencrypt`.
    * `customCertificateSecretName` — указываем имя secret'а в namespace `antiopa`, который будет использоваться для openvpn admin (данный секрет должен быть в формате [kubernetes.io/tls](https://kubernetes.github.io/ingress-nginx/user-guide/tls/#tls-secrets).
        * По-умолчанию `false`.
        * При указании этого параметра не забудьте выставить `certmanagerClusterIssuerName` в значение `false`.
    * Если вы хотите отключить https, то оба параметра необходимо выставить в `false`.
* `nodeSelector` — как в Kubernetes в `spec.nodeSelector` у pod'ов.
    * Если ничего не указано — будет [использоваться автоматика](/README.md#выделение-узлов-под-определенный-вид-нагрузки).
    * Можно указать `false`, чтобы не добавлять никакой nodeSelector.
* `tolerations` — как в Kubernetes в `spec.tolerations` у pod'ов.
    * Если ничего не указано — будет [использоваться автоматика](/README.md#выделение-узлов-под-определенный-вид-нагрузки).
    * Можно указать `false`, чтобы не добавлять никакие toleration'ы.


### Примеры конфигурации:

Минимальный конфиг bare metal

```
openvpn: |
  inlet: ExternalIp
  externalIp: 5.4.54.4
```

Минимальный конфиг aws и gcloud

```
openvpn: |
  inlet: LoadBalancer
```
