Модуль OpenVPN
=======

Предназначен для удобного доступа к ресурсам кластера.

Модуль ставит OpenVPN с аутентификацией на основе сертификатов и простой web-интерфейс.

Функции web-интерфейса:
* выпуск сертификатов;
* отзыв сертификатов;
* отмена отзыва сертификатов;
* получение готового пользовательского конфига.

В конфигурации по умолчанию клиентам пушатся:
* адрес kube-dns;
* роут в локальную сеть кластера;
* роут в сервисную сеть;
* роут в сеть подов.

Маршрут по умолчанию у клиентов не переопределяется.

### Включение модуля

Модуль по-умолчанию **выключен**. Для включения добавьте в CM `antiopa`:

```yaml
data:
  openvpnEnabled: "true"
```

### Параметры:
* `inlet` — способы подключения из внешнего мира.
    * Поддерживаются следующие inlet'ы
      * `ExternalIP` — когда имеются ноды с публичными IP. Используется в комбинации с параметром `externalIP`.
      * `LoadBalancer` — для AWS и gcloud.
      * `Direct` — для не стандартных случаев. В неймспейсе `kube-openvpn` необходимо создать сервис с именем `openvpn-external`, который отправляет трафик в под с лейблом `app: openvpn` на порт с именем `ovpn-tcp` (или просто 1194). Из этого сервиса парсится externalIP, ip балансера или host балансера. Если ничего этого нет, то необходимо указать параметр `externalHost`.
* `externalIP` — IP одной из нод кластера, который будет использоваться для подключения OpenVPN клиентов. Требуется только при использовании инлета `ExternalIP`.
* `externalPort` — порт, который вывешивается наружу на `externalIP` или балансере. По умолчанию задан `5416`.
* `tunnelNetwork` — подсеть используемая для туннеля. Значение по умолчанию `172.25.175.0/255.255.255.0`
* `pushToClientRoutes` — список роутов, которые отправляются клиентам при подключении. Если список пуст, то он сгенерируется автоматически из локальной сети кластера, сервисной подсети и подсети подов.
* `pushToClientDNS` — адрес dns-сервера, который отправляется клиентам при подключении. Если параметр не задан, то автоматически будет подставлен IP сервиса kube-system/kube-dns.
* `storageClass` — имя storageClass'а, который использовать.
    * Если не указано — используется или `global.storageClass` или `global.discovery.defaultStorageClass`, а если и они не указаны — данные сохраняются в emptyDir.
    * Если указать `false` — будет форсироваться использование emptyDir'а.
* `password` — пароль для http-авторизации для пользователя `admin` (генерируется автоматически, но можно менять)
    * Используется если не включен модуль `user-authn`.
* `externalHost` — IP или домен по которому клиенты подключаются к OpenVPN серверу. Если не задано, то информация берётся из сервиса с именем `openvpn-external`.
* `ingressClass` — класс ingress контроллера, который используется для админки openvpn.
    * Опциональный параметр, по-умолчанию используется глобальное значение `modules.ingressClass`.
* `https` — выбираем, какой типа сертификата использовать для админки openvpn.
    * `mode` — режим работы HTTPS:
        * `Disabled` — в данном режиме админка openvpn будет работать только по http;
        * `CertManager` — админка openvpn будет работать по https и заказывать сертификат с помощью clusterissuer заданном в параметре `certManager.clusterIssuerName`;
        * `CustomCertificate` — админка openvpn будет работать по https используя сертификат из namespace `antiopa`;
        * `OnlyInURI` — админка openvpn будет работать по http (подразумевая, что перед ними стоит внешний https балансер, который терминирует https) и все ссылки в `user-authn` будут генерироваться с https схемой.
    * `certManager`
      * `clusterIssuerName` — указываем, какой ClusterIssuer использовать для админки openvpn (в данный момент доступны `letsencrypt`, `letsencrypt-staging`, `selfsigned`, но вы можете определить свои).
        * По-умолчанию `letsencrypt`.
    * `customCertificate`
      * `secretName` - указываем имя secret'а в namespace `antiopa`, который будет использоваться для админки openvpn (данный секрет должен быть в формате [kubernetes.io/tls](https://kubernetes.github.io/ingress-nginx/user-guide/tls/#tls-secrets)).
        * По-умолчанию `false`.
* `nodeSelector` — как в Kubernetes в `spec.nodeSelector` у pod'ов.
    * Если ничего не указано — будет [использоваться автоматика](/README.md#выделение-узлов-под-определенный-вид-нагрузки).
    * Можно указать `false`, чтобы не добавлять никакой nodeSelector.
* `tolerations` — как в Kubernetes в `spec.tolerations` у pod'ов.
    * Если ничего не указано — будет [использоваться автоматика](/README.md#выделение-узлов-под-определенный-вид-нагрузки).
    * Можно указать `false`, чтобы не добавлять никакие toleration'ы.


### Примеры конфигурации:

Минимальный конфиг bare metal

```
openvpnEnabled: "true"
openvpn: |
  inlet: ExternalIp
  externalIP: 5.4.54.4
```

Минимальный конфиг aws и gcloud

```
openvpnEnabled: "true"
openvpn: |
  inlet: LoadBalancer
```
