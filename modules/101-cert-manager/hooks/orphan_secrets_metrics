#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    kubernetes:
    - name: certificates
      group: main
      queue: /modules/$(module::name::kebab_case)/metrics
      apiVersion: certmanager.k8s.io/v1alpha1
      kind: Certificate
      keepFullObjectsInMemory: false
      jqFilter: |
        {
          "namespace": .metadata.namespace,
          "secretName": .spec.secretName
        }
    - name: secrets
      group: main
      queue: /modules/$(module::name::kebab_case)/metrics
      apiVersion: v1
      kind: Secret
      keepFullObjectsInMemory: false
      labelSelector:
        matchExpressions:
        - key: certmanager.k8s.io/certificate-name
          operator: Exists
      jqFilter: |
        {
          "namespace": .metadata.namespace,
          "secretName": .metadata.name
        }

EOF
}

function __main__() {
  echo '{"group":"orphan_secrets_metrics_hook", "action":"expire"}' >> $METRICS_PATH

  # shellcheck disable=SC2016
  context::jq -rc '
    [.snapshots.secrets[].filterResult]      as $secrets |
    [.snapshots.certificates[].filterResult] as $certificates |
    ($secrets - $certificates)[] |
    {"group":"orphan_secrets_metrics_hook", "name": "d8_orphan_secrets_without_corresponding_certificate_resources", "set": 1, "labels": { "namespace": .namespace, "secret_name": .secretName}}
  ' >> "$METRICS_PATH"
}

hook::run "$@"
