---
title: "Мониторинг на базе Prometheus"
---

В Deckhouse реализованы широкие возможности по:
- мониторингу кластера Kubernetes, его компонентов и узлов,
- быстрой и простой интеграции prometheus и приложений в кластере для сбора метрик.

Для отображения графиков используется Grafana, а для отправки алертов можно использоваться типовые средства, например alertmanager.

## Cбор и хранение метрик
Deckhouse автоматически конфигурирует два типа инстансов prometheus для сбора и хранения метрик:
- детализированная статистика (интервал сбора – 30 секунд) хранится в течение последних 15 дней (по умолчанию);
- агрегированная статистика: для отслеживания трендов хранится в течение нескольких месяцев/лет (интервал сбора – 5 минут)

Поддерживается как pull, так и push-модель получения метрик.

На всех dashboard в Grafana реализована возможность выбора инстанса, с которого производить отображение графиков.

## Мониторинг аппаратных ресурсов
Реализовано отслеживание нагрузки на аппаратные ресурсы кластера, доступны графики по утилизации:
- процессора,
- памяти,
- диска,
- сети.

Данные графики доступны с агрегацией в разрезах по:
- подам,
- контроллерам,
- неймспейсам,
- нодам.

Кроме того, имеются графики по утилизированным и недоутилизированным серверным мощностям.

## Мониторинг Kubernetes

Deckhouse настраивает мониторинг широкого набора параметров “здоровья” Kubernetes и его компонентов, в частности:
- общей утилизации кластера;
- связанность нод Kubernetes между собой (измеряется rtt между всеми узлами);
- доступность и работоспособность компонентов control-plane:
  - `etcd`
  - `coredns` и `kube-dns`
  - `kube-apiserver` и пр.
- синхронизацию времени на нодах и пр.

## Мониторинг Ingress

Подробно описан [здесь](#TODO).

## Режим расширенного мониторинга
В Deckhouse возможно использование режима расширенного мониторинга, который дополнительно предоставляет возможности алертов по метрикам, собранным с помощью следующих экспортеров:
- `extended-monitoring-exporter`. Включает расширенный сбор метрик с namespace (у которых есть аннотация `extended-monitoring.flant.com/enabled=””`), в том числе сбор информации о доступных inodes и месте на дисках нод, мониторинг утилизации нод, доступность подов Deployment, `StatefulSet`, `DeamonSet` и пр;
- `image-availability-exporter`.  Добавляет метрики и включает отправку алертов, позволяющих узнать о проблемах с доступностью образа контейнера в registry, прописанному в поле image из spec pod’а в `Deployments`, `StatefulSets`, `DaemonSets`, `CronJobs`.

### Алертинг в режиме расширенного мониторинга
Deckhouse позволяет гибко настроить алертинг на каждый из namespace и указывать разную критичность в зависимости от порогового значения. Есть возможность указать множество пороговых значений отправки алертов в различных namespace, например, для таких параметров как:
- значения свободного места и inodes на диске
- утилизация CPU нод и контейнера
- количество 5xx ошибок на `nginx-ingress`
- количество возможных недоступных подов в `Deployment`, `StatefulSet`, `DeamonSet`.

## Алерты
Мониторинг в составе Deckhouse включает также и возможности уведомления о событиях. В стандартной поставке уже идет большой набор только необходимых алертов, покрывающих состояние кластера и его компонентов. При этом всегда остается возможность добавления кастомных алертов.

### Отправка алертов во внешние системы
Deckhouse поддерживает отправку алертов с помощью `Alertmanager`:
- по протоколу SMTP;
- в PagerDuty;
- в Slack;
- в Telegram;
- посредством Webhook;
- и любым другим, поддерживаемым в alertmanager, каналам.
