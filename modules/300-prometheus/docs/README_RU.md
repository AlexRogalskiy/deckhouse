---
title: "Prometheus-мониторинг"
type:
  - instruction
search: prometheus
---

Устанавливает и полностью настраивает [Prometheus](https://prometheus.io/), настраивает сбор метрик со многих распространенных приложений, а так же предоставляет необходимый минимальный набор alert'ов для Prometheus и dasboard для Grafana.

Устанавливается два экземпляра Prometheus:
* **main** — основной Prometheus, который выполняет scrape каждые 30 секунд (с помощью параметра `scrapeInterval` можно изменить это значение). Именно он обрабатывает все правила, шлет алерты и является основным источником данных.
* **longterm** — дополнительный Prometheus, который выполняет scrape данных из main каждые 5 минут (с помощью параметра `longtermScrapeInterval` можно изменить это значение).. Используется для продолжительного хранения истории и для отображения больших промежутков времени.

Когда данный Prometheus установлен на Kubernetes 1.11 и имеет storage class, поддерживающий [автоматическое расширение диска](https://kubernetes.io/blog/2018/07/12/resizing-persistent-volumes-using-kubernetes/), в случае, если в prometheus не будет помещаться данные, то диск будет автоматически расширяться. В ином случае придет алерт о том, что дисковое пространство в Prometheus заканчивается.

Ресурсы cpu и memory автоматически выставляются при пересоздании пода на основе истории потребления, благодаря модулю [Vertical Pod Autoscaler](../../modules/302-vertical-pod-autoscaler/). Так же, благодаря кешированию запросов к Prometheus с помощью trickster, потребление памяти Prometheus сильно сокращается.

<!--Дополнительная информация-->
<!-- -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!---->
<!--* [Разработка правил для Prometheus (алертов и recording)](prometheus_rules_development.html)-->
<!--* [Разработка графиков (Dashboard'ов для Grafana)](grafana_dashboard_development.html)-->
<!--* [Разработка target'ов для Prometheus (целей, которые мониторить)](prometheus_targets_development.html)-->

Поддерживается как pull, так и push-модель получения метрик.

## Мониторинг аппаратных ресурсов
Реализовано отслеживание нагрузки на аппаратные ресурсы кластера с графиками по утилизации:
- процессора,
- памяти,
- диска,
- сети.

Графики доступны с агрегацией в разрезе по:
- подам,
- контроллерам,
- неймспейсам,
- нодам.

## Мониторинг Kubernetes

Deckhouse настраивает мониторинг широкого набора параметров “здоровья” Kubernetes и его компонентов, в частности:
- общей утилизации кластера;
- связанность нод Kubernetes между собой (измеряется rtt между всеми узлами);
- доступность и работоспособность компонентов control-plane:
  - `etcd`
  - `coredns` и `kube-dns`
  - `kube-apiserver` и пр.
- синхронизацию времени на нодах и пр.

## Мониторинг Ingress

Подробно описан здесь (#TODO).

## Режим расширенного мониторинга
В Deckhouse возможно использование режима расширенного мониторинга, который дополнительно предоставляет возможности алертов по метрикам, собранным с помощью следующих экспортеров:
- `extended-monitoring-exporter`. Включает расширенный сбор метрик с namespace (у которых есть аннотация `extended-monitoring.flant.com/enabled=””`), в том числе сбор информации о доступных inodes и месте на дисках нод, мониторинг утилизации нод, доступность подов Deployment, `StatefulSet`, `DaemonSet` и пр;
- `image-availability-exporter`.  Добавляет метрики и включает отправку алертов, позволяющих узнать о проблемах с доступностью образа контейнера в registry, прописанному в поле image из spec pod’а в `Deployments`, `StatefulSets`, `DaemonSets`, `CronJobs`.

### Алертинг в режиме расширенного мониторинга
Deckhouse позволяет гибко настроить алертинг на каждый из namespace и указывать разную критичность в зависимости от порогового значения. Есть возможность указать множество пороговых значений отправки алертов в различных namespace, например, для таких параметров как:
- значения свободного места и inodes на диске
- утилизация CPU нод и контейнера
- количество 5xx ошибок на `nginx-ingress`
- количество возможных недоступных подов в `Deployment`, `StatefulSet`, `DaemonSet`.

## Алерты
Мониторинг в составе Deckhouse включает также и возможности уведомления о событиях. В стандартной поставке уже идет большой набор только необходимых алертов, покрывающих состояние кластера и его компонентов. При этом всегда остается возможность добавления кастомных алертов.

### Отправка алертов во внешние системы
Deckhouse поддерживает отправку алертов с помощью `Alertmanager`:
- по протоколу SMTP;
- в PagerDuty;
- в Slack;
- в Telegram;
- посредством Webhook;
- и любым другим, поддерживаемым в alertmanager, каналам.
