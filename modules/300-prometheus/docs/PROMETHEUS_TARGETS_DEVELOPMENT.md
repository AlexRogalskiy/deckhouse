Разработка target'ов Prometheus
===============================

Общая информация
----------------

* Наиболее частая операция — добавление target'а для нового application'а (redis, rabbitmq и др.). Скорей всего для этого будет достаточно просто скопировать один из существующих service monitor'ов в директории [applications](../templates/prometheus-targets/applications/) и поправить названия.
* Но если вам нужно сделать что-то более сложное, или если простое копирование не дает ожидаемого результата — придется разбираться и читать [документацию по внутреннему устройству](../../200-prometheus-operator/docs/INTERNALS.md) Prometheus Operator.
* Все существующие target'ы лежат в директории [prometheus-targets](../templates/prometheus-targets/), они обычно состоят из service monitor'а, некоторого exporter'а для Prometheus и необходимой обвязки, которая их стыкует.

Лучшие практики
---------------

### Лейблы pod-ориентированных метрик

Абсолютное большинство метрик, хранимых в Prometheus, или содержит информацию о параметрах самого pod'а, или информацию о параметрах приложения, запущенного в pod'е. Мы называем все такие метрики pod-ориентированными, и относим к ним (преимущественно, но не исключительно):
* системные метрики, отражающие параметры производительности самого пода (экспортируются kubelet'ом)
* прикладные метрики:
    * метрики поддерживаемых application'ов (redis, rabbitmq и др.)
    * custom-метрики

У всех pod-ориентированных метрик обязательно есть лейбл с именем pod'а (обычно он называется `instance`, но у метрик получаемых из kubelet'а — `pod_name, а у kube-state-metrics — `pod`), но работать с именами pod'ов не удобно, а удобно нам работать с `service` и `namespace`, поэтому:
* у всех без исключения pod-ориентированных метрик есть лейбл `namespace`,
* у прикладных (applications и custom) pod-ориентированных метрик есть лейбл `service`, определяющий группу pod'ов под одним понятным названием.

### Аутентификация доступа к экспортируемым метрикам

Мы не определились, стоит ли делать обязательную аутентификацию запросов от Prometheus в exporter'ах, или не стоит, или стоит внедрять Network Policices. В целом — конечно стоит, но мы пока не нашли удобного, и в тоже время надежного, способа, чтобы требовать от всех exporter'ов обязательную аутентификацию. Часть служебных target'ов (например node-exporter и kube-state-metrics) используют [kube-rbac-proxy](https://github.com/brancz/kube-rbac-proxy) для аутентификации, но вряд ли этот путь станет стандартным, так как kube-rbac-proxy проверяет каждый запрос у apiserver'а, а это — SPOF.
