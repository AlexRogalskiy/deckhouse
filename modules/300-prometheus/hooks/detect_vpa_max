#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
# TODO
#{
#  "beforeHelm": 20,
#   "onKubernetesEvent": [
#      {
#         "kind": "node",
#         "event": [
#            "add",
#            "update",
#            "delete"
#         ],
#         "jqFilter": ".status.capacity.pods"
#      }
#   ]
#}'

  cat << EOF
    configVersion: v1
    beforeHelm: 20
    schedule:
    - name: detect_vpa_max
      queue: /modules/$(module::name::kebab_case)/detect_vpa_max
      crontab: "*/10 * * * *"
EOF
}

function __main__() {
  # Prometheus resources
  memory_per_pod="15"
  cpu_per_pod="0.02"
  pod_count=$(kubectl get node -o json | jq -r '[.items[].status.capacity.pods | tonumber] | add')
  max_memory="$(bc -l <<< "scale=2; $pod_count * $memory_per_pod / 1")Mi"
  max_cpu="$(bc -l <<< "scale=2; $pod_count * $cpu_per_pod / 1")"
  values::set prometheus.internal.vpa.maxMemory "$max_memory"
  values::set prometheus.internal.vpa.maxCPU "$max_cpu"

  # 3 times less for longterm
  max_memory="$(bc -l <<< "scale=2; $pod_count * $memory_per_pod / 3")Mi"
  max_cpu="$(bc -l <<< "scale=2; $pod_count * $cpu_per_pod / 3")"
  values::set prometheus.internal.vpa.longtermMaxMemory "$max_memory"
  values::set prometheus.internal.vpa.longtermMaxCPU "$max_cpu"
}

hook::run "$@"
