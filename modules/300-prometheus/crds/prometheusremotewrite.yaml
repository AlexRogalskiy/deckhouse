apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: prometheusremotewrites.deckhouse.io
  labels:
    heritage: deckhouse
    module: prometheus
spec:
  group: deckhouse.io
  scope: Cluster
  names:
    plural: prometheusremotewrites
    singular: prometheusremotewrite
    kind: PrometheusRemoteWrite
  preserveUnknownFields: false
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: |
            Ресурс для включения `remote_write` данных из локального Prometheus в отдельный longterm storage (например: [VictoriaMetrics](https://github.com/VictoriaMetrics/VictoriaMetrics)).

            Таких ресурсов в кластере может быть любое количество.
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - url
              properties:
                url:
                  x-description: The URL of the endpoint to send samples to.
                  description: |
                    Адрес, по которому Prometheus будет отправлять данные.
                  type: string
                  example: https://victoriametrics-test.domain.com/api/v1/write
                basicAuth:
                  x-description: BasicAuth for the URL.
                  description: Параметры базовой авторизации для отправки данных.
                  properties:
                    password:
                      description: Пароль для аутентификации.
                      type: string
                    username:
                      description: Имя пользователя для аутентификации.
                      type: string
                  required:
                  - password
                  - username
                  type: object
                writeRelabelConfigs:
                  x-description: The list of remote write relabel configurations.
                  description: |
                    Параметры для relabel'инга данных для отправки.

                    Например, если необходимо удалить лишние метрики или произвести [релейбл данных](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#metric_relabel_configs).
                  type: array
                  items:
                    type: object
                    properties:
                      action:
                        x-description: Action to perform based on regex matching.
                        description: |
                          Действие, выполняемое при соответствии регулярному выражению.
                        type: string
                        default: replace
                      modulus:
                        description: |
                          Модуль для хеширования значений исходного лейбла.
                        x-description: Modulus to take of the hash of the source label values.
                        format: int64
                        type: integer
                      regex:
                        x-description: Regular expression against which the extracted value is matched. Default is '(.*)'
                        description: |
                          Регулярное выражение для применения к извлеченному значению.
                        type: string
                        default: '(.*)'
                      replacement:
                        x-description: Replacement value against which a regex replace is performed if the regular expression matches. Regex capture groups are available. Default is '$1'
                        description: |
                          На что заменять, в случае соответствия шаблону регулярного выражения.

                          Доступны regexp-группы.
                        type: string
                        default: '$1'
                      separator:
                        x-description: Separator placed between concatenated source label values. default is ';'.
                        description: |
                          Символ, разделяющий исходные метки.
                        type: string
                        default: ';'
                      sourceLabels:
                        type: array
                        x-description: The source labels select values from existing labels. Their content is concatenated using the configured separator and matched against the configured regular expression for the replace, keep, and drop actions.
                        description: |
                          Исходные метки для выбора значений.

                          Исходные метки объединяются с учетом разделителя (`separator`), и к ним применяется фильтр регулярного выражения, по результатам чего содержимое заменяется, принимается или удаляется.
                        items:
                          type: string
                      targetLabel:
                        x-description: Label to which the resulting value is written in a replace action. It is mandatory for replace actions. Regex capture groups are available.
                        description: |
                          Метка, в которую записывается результирующее значение при замене.

                          Поле является обезательным при `action: replace`.
                        type: string
      additionalPrinterColumns:
        - name: URL
          type: string
          jsonPath: .spec.url
          description: 'Prometheus Remote write URL.'
