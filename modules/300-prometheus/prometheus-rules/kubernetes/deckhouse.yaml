- name: kubernetes.deckhouse
  rules:
  - alert: DeckhouseIsNotRunning
    expr: min(kube_pod_status_ready{condition="true", namespace="d8-system", pod=~"deckhouse-.*"}) != 1
    for: 30m
    labels:
      severity: critical
    annotations:
      summary: Deckhouse не работает
      description: |
        Pod deckhouse более 30 минут НЕ находится в состоянии Ready.
  - alert: DeckhouseIsNotRunning
    expr: max(increase(deckhouse_live_ticks[1m])) < 1
    for: 30m
    labels:
      severity: critical
    annotations:
      summary: Deckhouse не работает
      description: |
        В prometheus более 30 минут не увеличивается метрика deckhouse_live_ticks (а должна каждые 10 секунд).
  - alert: DeckhouseIsHung
    expr: max(min_over_time(deckhouse_tasks_queue_length[2m])) > 10
    for: 30m
    labels:
      severity: critical
    annotations:
      summary: Deckhouse зависла
      description: |
        Deckhouse более 30 минут не может обработать очередь, в которой скопилось {{ $value }} заданий.

  - alert: DeckhouseIsRestartingTooOften
    expr: max(increase(kube_pod_container_status_restarts_total{namespace="d8-system", pod=~"deckhouse-.*"}[1h])) > 3
    for: 3h
    labels:
      severity: critical
    annotations:
      summary: Deckhouse слишком часто перезагружается
      description: |
        Количество перезапусков за последний час: {{ $value }}.

        Частый перезапуск Deckhouse не является нормальной ситуацией — deckhouse должна быть постоянно запущена и работать.

  - alert: DeckhouseHasNoAccessToRegistry
    expr: max(increase(deckhouse_registry_errors[5m])) > 0
    for: 6h
    labels:
      severity: critical
    annotations:
      summary: Deckhouse не может подключиться к registry
      description: |
        У deckhouse более 6 часов нет доступа к registry (обычно registry.flant.com), в котором она каждые 15 секунд проверяет наличие нового Docker образа. Пока у deckhouse нет доступа к registry — она не будет автоматически обновляться.

        Обычно этот алерт означает, что у pod'а deckhouse есть какие-то проблемы с доступом в интернет.

  - alert: DeckhouseGlobalHookFailsTooOften
    expr: max(increase({job="deckhouse", __name__=~"deckhouse_global_hook.*_errors"}[1h])) by (hook) > 1
    for: 12h
    labels:
      severity: critical
    annotations:
      summary: Глобальный хук Deckhouse падает слишком часто
      descritipion: |
        Глобальный хук {{ $labels.hook }} падает каждый час уже на протяжении более 12 часов
  - alert: DeckhouseModuleHookFailsTooOften
    expr: max(increase({job="deckhouse", __name__=~"deckhouse_module_hook.*_errors"}[1h])) by (module, hook) > 1
    for: 12h
    labels:
      severity: critical
    annotations:
      summary: Модульный хук Deckhouse падает слишком часто
      descritipion: |
        Хук {{ $labels.hook }} модуля {{ $labels.module }} падает каждый час уже на протяжении более 12 часов


  - alert: DeckhouseCouldNotDiscoverModules
    expr: max(increase(deckhouse_modules_discover_errors[2m])) > 1
    for: 30m
    labels:
      severity: debug
  - alert: DeckhouseCouldNotRunModule
    expr: max(increase(deckhouse_module_run_errors[2m])) by (module) > 1
    for: 30m
    labels:
      severity: debug
  - alert: DeckhouseCouldNotDeleteModule
    expr: max(increase(deckhouse_module_delete_errors[2m])) by (module) > 1
    for: 30m
    labels:
      severity: debug
  - alert: DeckhouseCouldNotRunGlobalHook
    expr: max(increase(deckhouse_global_hook_errors[2m])) by (hook) > 1
    for: 30m
    labels:
      severity: debug
  - alert: DeckhouseCouldNotRunModuleHook
    expr: max(increase(deckhouse_module_hook_errors[2m])) by (module, hook) > 1
    for: 30m
    labels:
      severity: debug
