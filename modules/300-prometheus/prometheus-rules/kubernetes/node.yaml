- name: kubernetes.node
  rules:
  - record: node_ntp_offset_seconds:abs
    expr: abs(node_ntp_offset_seconds)

  - alert: NodeNtpInsane
    expr: (min by (node) (node_ntp_sanity)) == 0
    for: 1m
    labels:
      impact: critical
      likelihood: certain
    annotations:
      polk_flant_com_markup_format: markdown
      description: |
        Please, check the following values:
        1. Absolute offset: {{ printf "node_ntp_offset_seconds:abs{node=\"%s\"}" $labels.node | query | first | value }}. Should be less than 0.001 seconds.
        2. Root distance: {{ printf "(node_ntp_rtt_seconds{node=\"%s\"} + node_ntp_root_delay_seconds{node=\"%s\"}) / 2 + node_ntp_root_dispersion_seconds{node=\"%s\"}" $labels.node $labels.node $labels.node | query | first | value }}. Should be less than 3.46608 seconds.
        3. Stratum: {{ printf "node_ntp_stratum{node=\"%s\"}" $labels.node | query | first | value }}. Should be less than 16.
      summary: Node {{$labels.node}} is not sane

  - alert: NodeTimeOutOfSync
    expr: max by (node) (abs(node_time_seconds - timestamp(node_time_seconds)) > 10)
    for: 5m
    labels:
      impact: critical
      likelihood: certain
    annotations:
      polk_flant_com_markup_format: markdown
      description: |
        Node's {{$labels.node}} time is out of sync from Prometheus node by {{ $value }} seconds
      summary: Node's {{$labels.node}} clock is drifting

  - alert: NodePingPacketLoss
    expr: >-
      (
        sum by (destination_node) (increase(kube_node_ping_packets_sent_total[5m]))
        -
        sum by (destination_node) (increase(kube_node_ping_packets_received_total[5m]))
      )
      /
      sum by (destination_node) (increase(kube_node_ping_packets_sent_total[5m]))  > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      description: ICMP packet loss to node {{$labels.destination_node}} is more than 5%
      summary: Ping loss more than 5%

  # remove after https://github.com/prometheus/node_exporter/issues/1339 gets fixed
  - alert: NodeExporterMountStuck
    expr: >-
      max by (node) (node_filesystem_size_bytes{mountpoint="/"}) == on (node) group_right() node_filesystem_size_bytes{mountpoint!="/", fstype!~"ceph|nfs.*"}
    for: 5m
    labels:
      severity: critical
    annotations:
      polk_flant_com_markup_format: markdown
      description: |
        Restart node_exporter on node {{$labels.node}}:

        ```bash
        kubectl -n kube-prometheus get pod -o wide | grep node-exporter | grep {{$labels.node}}
        kubectl delete pod ...
        ```

        See https://github.com/deckhouse/deckhouse/issues/491 for details.
      summary: >
        node_exporter on Node {{$labels.node}} is stuck
