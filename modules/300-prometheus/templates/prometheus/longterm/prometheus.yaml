{{- if .Values.prometheus.longtermRetentionDays }}
{{- if (.Values.global.enabledModules | has "vertical-pod-autoscaler-crd") }}
---
apiVersion: autoscaling.k8s.io/v1beta2
kind: VerticalPodAutoscaler
metadata:
  name: prometheus-longterm
  namespace: d8-monitoring
{{ include "helm_lib_module_labels" (list . (dict "app" "prometheus")) | indent 2 }}
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: StatefulSet
    name: prometheus-longterm
  updatePolicy:
    updateMode: {{ .Values.prometheus.vpa.updateMode | quote }}
  resourcePolicy:
    containerPolicies:
    - containerName: "prometheus"
      maxAllowed:
        cpu: {{ .Values.prometheus.vpa.longtermMaxCPU | default .Values.prometheus.internal.vpa.longtermMaxCPU | quote }}
        memory: {{ .Values.prometheus.vpa.longtermMaxMemory | default .Values.prometheus.internal.vpa.longtermMaxMemory | quote }}
{{- end }}
---
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: longterm
  namespace: d8-monitoring
{{ include "helm_lib_module_labels" (list . (dict "app" "prometheus")) | indent 2 }}
spec:
  replicas: 1
  retention: {{ .Values.prometheus.longtermRetentionDays }}d
  retentionSize: {{ .Values.prometheus.longtermRetentionGigabytes }}GB
  image: {{ .Values.global.modulesImages.registry }}/prometheus/prometheus:{{ .Values.global.modulesImages.tags.prometheus.prometheus }}
  version: v2.13.0
  imagePullSecrets:
  - name: deckhouse-registry
  listenLocal: true
  containers:
  - name: kube-rbac-proxy
    image: {{ .Values.global.modulesImages.registry }}/common/kube-rbac-proxy:{{ .Values.global.modulesImages.tags.common.kubeRbacProxy }}
    args:
    - "--secure-listen-address=$(MY_POD_IP):9090"
    - "--client-ca-file=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
    - "--v=2"
    - "--logtostderr=true"
    - "--stale-cache-interval=1h30m"
    ports:
    - containerPort: 9090
      name: https
    env:
    - name: MY_POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: KUBE_RBAC_PROXY_CONFIG
      value: |
        excludePaths:
        - /-/healthy
        - /-/ready
        upstreams:
        - upstream: http://127.0.0.1:9090/
          path: /
          authorization:
            resourceAttributes:
              namespace: d8-monitoring
              apiGroup: monitoring.coreos.com
              apiVersion: v1
              resource: prometheuses
              subresource: http
              name: longterm
    securityContext:
      runAsUser: 0
  - name: prometheus
    livenessProbe:
      failureThreshold: 6
      httpGet:
        path: /-/healthy
        port: probe
        scheme: HTTPS
      periodSeconds: 5
      successThreshold: 1
      timeotSeconds: 3
    readinessProbe:
      failureThreshold: 120
      httpGet:
        path: /-/ready
        port: probe
        scheme: HTTPS
      periodSeconds: 5
      successThreshold: 1
      timeoutSeconds: 3
    ports:
    - name: probe
      containerPort: 9090
  scrapeInterval: 5m
  evaluationInterval: 5m
{{- if .Values.global.modules.publicDomainTemplate }}
  externalUrl: {{ include "helm_lib_module_uri_scheme" . }}://{{ include "helm_lib_module_public_domain" (list . "grafana") }}/prometheus/longterm/
{{- end }}
  securityContext:
    fsGroup: 2000
    runAsUser: 1000
  serviceAccountName: prometheus
  podMetadata:
    annotations:
      threshold.extended-monitoring.flant.com/disk-bytes-warning: "97"
      threshold.extended-monitoring.flant.com/disk-bytes-critical: "99"
  secrets:
  - prometheus-api-client-tls
{{- include "helm_lib_node_selector" (tuple . "monitoring") | indent 2 }}
{{- include "helm_lib_tolerations" (tuple . "monitoring") | indent 2 }}
{{- include "helm_lib_priority_class" (tuple . "cluster-low") | indent 2 }}
  {{- $storageClass := .Values.prometheus.longtermStorageClass | default .Values.prometheus.storageClass | default .Values.global.storageClass | default .Values.global.discovery.defaultStorageClass }}
  {{- if $storageClass }}
  storage:
    # TODO: Remove the following 3 lines with empty values after prometheus-operator update
    class: ""
    selector: {}
    resources: {}
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: {{ .Values.prometheus.longtermDiskSize }}Gi
        storageClassName: {{ $storageClass }}
  {{- end }}
{{- end }}
