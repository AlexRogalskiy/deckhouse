{{- if eq .Values.global.cluster.type "Manual" }}
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: kube-prometheus-kube-control-plane-proxy
  namespace: kube-system
  labels:
    heritage: antiopa
    module: {{ $.Chart.Name }}
    app: kube-prometheus-kube-control-plane-proxy
spec:
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: kube-prometheus-kube-control-plane-proxy
  template:
    metadata:
      labels:
        app: kube-prometheus-kube-control-plane-proxy
    spec:
      serviceAccountName: kube-prometheus-kube-control-plane-proxy
      hostNetwork: true
      containers:
      - name: nginx
        image: {{ $.Values.global.modulesImages.registry }}/prometheus/kube-control-plane-proxy:{{ $.Values.global.modulesImages.tags.prometheus.kubeControlPlaneProxy }}
        ports:
        - containerPort: 10360
          name: scheduler
        - containerPort: 10362
          name: controller
      - name: kube-rbac-proxy-for-kube-scheduler
        image: quay.io/brancz/kube-rbac-proxy:v0.2.0
        args:
        - "--secure-listen-address=127.0.0.1:10361"
        - "--upstream=http://127.0.0.1:10251/"
      - name: kube-rbac-proxy-for-kube-controller-manager
        image: quay.io/brancz/kube-rbac-proxy:v0.2.0
        args:
        - "--secure-listen-address=127.0.0.1:10363"
        - "--upstream=http://127.0.0.1:10252/"
      nodeSelector:
        node-role.kubernetes.io/master: ""
      tolerations:
      - operator: Exists
      imagePullSecrets:
      - name: antiopa-registry
{{- end }}
