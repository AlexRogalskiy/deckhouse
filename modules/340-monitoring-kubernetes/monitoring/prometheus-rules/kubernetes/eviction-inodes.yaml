# Алертинг разбит на пороги, зависящие от процента занятого места относительно eviction thresholds
#
# impact везде critical
#
# Список likelihood порогов:
# * rare — -5% soft порога (или -10% hard, если soft не стоит)
# * unlikely — перешли soft
# * possible — -5% от hard
# * likely — перешли hard
# * certain — места нет, всё очень плохо

- name: kubelet.inodes.evictions
  rules:
  - alert: KubeletNodeFSInodesUsage
    expr: |
      (
        (
          max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
          max by (node, mountpoint) (kubelet_eviction_nodefs_inodes{type="soft"} - 5)
        )
        or
        (
          max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
          max by (node, mountpoint) (kubelet_eviction_nodefs_inodes{type="soft"} - 10)
        )
      ) * 100
    for: 1m
    labels:
      impact: critical
      likelihood: rare
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to soft eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_nodefs_inodes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"} or kubelet_eviction_nodefs_inodes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to soft eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletNodeFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_nodefs_inodes{type="soft"})
      ) * 100
    labels:
      impact: critical
      likelihood: unlikely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Soft eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_nodefs_inodes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Soft eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.

  - alert: KubeletNodeFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_nodefs_inodes{type="hard"} - 5)
      ) * 100
    for: 1m
    labels:
      impact: critical
      likelihood: possible
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to hard eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_nodefs_inodes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to hard eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletNodeFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_nodefs_inodes{type="hard"})
      ) * 100
    labels:
      impact: critical
      likelihood: likely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Hard eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_nodefs_inodes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Hard eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.

  - alert: KubeletNodeFSInodesUsage
    expr: |
      (
        (
          max by (node, mountpoint) (node_filesystem_avail_bytes)
        ) == 0
      )
      * (max by (node, mountpoint) ({__name__=~"kubelet_eviction_nodefs_inodes"}))
    labels:
      impact: critical
      likelihood: certain
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      summary: >
        No more free inodes on nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.


  - alert: KubeletImageFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_imagefs_inodes{type="soft"} - 5)
      ) * 100
    for: 1m
    labels:
      impact: critical
      likelihood: rare
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to soft eviction threshold of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_imagefs_inodes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to soft eviction threshold of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletImageFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_imagefs_inodes{type="soft"})
      ) * 100
    labels:
      impact: critical
      likelihood: unlikely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Soft eviction of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_imagefs_inodes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Soft eviction of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.

  - alert: KubeletImageFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_imagefs_inodes{type="soft"} - 5)
      ) * 100
    for: 1m
    labels:
      impact: critical
      likelihood: possible
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to hard eviction threshold of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_imagefs_inodes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to hard eviction threshold of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletImageFSInodesUsage
    expr: |
      (
        max by (node, mountpoint) (node_filesystem_files_free / node_filesystem_files) >
        max by (node, mountpoint) (kubelet_eviction_imagefs_inodes{type="soft"})
      ) * 100
    labels:
      impact: critical
      likelihood: likely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Hard eviction of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_imagefs_inodes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Hard eviction of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.


  - alert: KubeletImageFSInodesUsage
    expr: |
      (
        (
          max by (node, mountpoint) (node_filesystem_avail_bytes)
        ) == 0
      )
      * (max by (node, mountpoint) ({__name__=~"kubelet_eviction_imagefs_inodes"}))
    labels:
      impact: critical
      likelihood: certain
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      summary: >
        No more free inodes on imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
