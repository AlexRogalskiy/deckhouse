# Алертинг разбит на пороги, зависящие от процента занятого места относительно eviction thresholds
#
# impact везде critical
#
# Список likelihood порогов:
# * rare — -5% soft порога (или -10% hard, если soft не стоит)
# * unlikely — перешли soft
# * possible — -5% от hard
# * likely — перешли hard
# * certain — места нет, всё очень плохо
- name: kubelet.bytes.evictions
  rules:
  - alert: KubeletNodeFSBytesUsage
    expr: |
      (
        (
          max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
          max by (node, mountpoint) (kubelet_eviction_nodefs_bytes{type="soft"} - 5)
        )
        or
        (
          max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
          max by (node, mountpoint) (kubelet_eviction_nodefs_bytes{type="hard"} - 10)
        )
      )
    for: 1m
    labels:
      impact: critical
      likelihood: rare
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to soft eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_nodefs_bytes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"} or kubelet_eviction_nodefs_bytes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to soft eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletNodeFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_nodefs_bytes{type="soft"})
      )
    labels:
      impact: critical
      likelihood: unlikely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Soft eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_nodefs_bytes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Soft eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.

  - alert: KubeletNodeFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_nodefs_bytes{type="hard"} - 5)
      )
    for: 1m
    labels:
      impact: critical
      likelihood: possible
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to hard eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_nodefs_bytes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to hard eviction threshold of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletNodeFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_nodefs_bytes{type="hard"})
      )
    labels:
      impact: critical
      likelihood: likely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Hard eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_nodefs_bytes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Hard eviction of nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.

  - alert: KubeletNodeFSBytesUsage
    expr: |
      (
        (
          max by (node, mountpoint) (node_filesystem_avail_bytes)
        ) == 0
      )
      * (max by (node, mountpoint) ({__name__=~"kubelet_eviction_nodefs_bytes"}))
    labels:
      impact: critical
      likelihood: certain
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      summary: >
        No more free bytes on nodefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.


  - alert: KubeletImageFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_imagefs_bytes{type="soft"} - 5)
      )
    for: 1m
    labels:
      impact: critical
      likelihood: rare
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to soft eviction threshold of imagefs (filesystem that container runtimes uses for storing images and container writable layers) on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_imagefs_bytes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to soft eviction threshold of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletImageFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_imagefs_bytes{type="soft"})
      )
    labels:
      impact: critical
      likelihood: unlikely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Soft eviction of imagefs (filesystem that container runtimes uses for storing images and container writable layers) on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_imagefs_bytes{type=\"soft\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Soft eviction of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.

  - alert: KubeletImageFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_imagefs_bytes{type="hard"} - 5)
      )
    for: 1m
    labels:
      impact: critical
      likelihood: possible
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Close to hard eviction threshold of imagefs (filesystem that container runtimes uses for storing images and container writable layers) on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
        Threshold at: {{ printf "kubelet_eviction_imagefs_bytes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Close to hard eviction threshold of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.

  - alert: KubeletImageFSBytesUsage
    expr: |
      (
        max by (node, mountpoint) ((node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes) * 100 >
        max by (node, mountpoint) (kubelet_eviction_imagefs_bytes{type="hard"})
      )
    labels:
      impact: critical
      likelihood: likely
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        Hard eviction of imagefs (filesystem that container runtimes uses for storing images and container writable layers) on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.
        Threshold at: {{ printf "kubelet_eviction_imagefs_bytes{type=\"hard\", node=\"%s\", mountpoint=\"%s\"}" $labels.node $labels.mountpoint | query | first | value }}%
        Currently at: {{ .Value }}%
      summary: >
        Hard eviction of imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}} is in progress.


  - alert: KubeletImageFSBytesUsage
    expr: |
      (
        (
          max by (node, mountpoint) (node_filesystem_avail_bytes)
        ) == 0
      )
      * (max by (node, mountpoint) ({__name__=~"kubelet_eviction_imagefs_bytes"}))
    labels:
      impact: critical
      likelihood: certain
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |
        No more free bytes on imagefs (filesystem that container runtimes uses for storing images and container writable layers) on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
      summary: >
        No more free bytes on imagefs on node {{$labels.node}} mountpoint {{$labels.mountpoint}}.
