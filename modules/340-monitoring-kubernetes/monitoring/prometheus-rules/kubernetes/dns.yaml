- name: kubernetes.dns
  rules:
  - alert: KubernetesDnsDown
    expr: absent(up{job=~"kube-dns|coredns"} == 1)
    for: 5m
    labels:
      impact: critical
      likelihood: certain
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |-
        Нет ни одного работающего пода kube-dns или coredns. DNS внутри кластера не работает! Приложения не могут разыменовать внутренние сервисы и внешние домены.
        Что делать:
        1. `kubectl -n kube-system describe deployment -l k8s-app=kube-dns`
        2. `kubectl -n kube-system describe pod -l k8s-app=kube-dns`
      summary: >
        Kube-dns или CoreDNS не работает.
  - alert: KubernetesDnsError
    expr: sum by (pod) (coredns_panic_count_total{job="coredns"}) > 0
    labels:
      impact: marginal
      likelihood: possible
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: markdown
      description: |-
        Данный алерт говорит о том, что у CoreDNS в поде {{$labels.pod}} произошла как минимум одна критическая ошибка.

        В обычном состоянии таких проблем никогда не должно быть.
        Что делать:
        1. Посмотреть логи контейнера: `kubectl -n kube-system logs {{$labels.pod}}`
        2. Если проблема не локальная и не понятно что с ней делать – сообщить в команду RnD, в канал `tech-kubernetes`
      summary: >
        У CoreDNS происходят критические ошибки.
