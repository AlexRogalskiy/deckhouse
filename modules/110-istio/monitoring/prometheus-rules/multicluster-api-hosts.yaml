- name: kubernetes.istio.multicluster_api_hosts
  rules:
    - alert: D8IstioMulticlusterRemoteApiHostDoesntWork
      expr: max by (multicluster_name, api_host) (d8_istio_multicluster_api_host_check_error_count == 1)
      for: 5m
      labels:
        severity_level: "6"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        plk_create_group_if_not_exists__d8_istio_multicluster_remote_api_host_failed: D8IstioMulticlusterRemoteApiHostFailed,tier=~tier
        plk_grouped_by__d8_istio_multicluster_remote_api_host_failed: D8IstioMulticlusterRemoteApiHostFailed,tier=~tier
        description: |
          Remote api host `{{$labels.api_host}}` for IstioMulticluster `{{$labels.multicluster_name}}` has failed healthcheck by d8 monitoring hook.
          Reproducing:
          ```
          CERT="$(kubectl -n d8-istio get secret client-cert -o json | jq -r '.data."tls.crt"' | base64 -d)"
          KEY="$(kubectl -n d8-istio get secret client-cert -o json | jq -r '.data."tls.key"' | base64 -d)"
          curl https://{{$labels.api_host}}/version --cert <(echo "$CERT") --key <(echo "$KEY")
          ```
        summary: Multicluster remote api host failed
