{{- if or .Values.istio.federation.enabled .Values.istio.multicluster.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: remote-root-ca
  namespace: d8-{{ .Chart.Name }}
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
data:
  # ca.crt must contain something, it is ingress-nginx-controller requirement.
  {{ $remoteRootCAs := .Values.istio.internal.remoteRootCAs }}
  {{ $remoteRootCAs = prepend $remoteRootCAs .Values.istio.internal.ca.root }}
  ca.crt: {{ $remoteRootCAs | join "\n" | b64enc | quote }}
---
# By deploying this ingress we trigger "nginx reload" in ingress-nginx-controller.
# It is required to update CA bundle which is used to verify client certififcates.
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: fakeingress
  namespace: d8-{{ .Chart.Name }}
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
  annotations:
    kubernetes.io/ingress.class: {{ include "helm_lib_module_ingress_class" . | quote }}
spec:
  rules:
  - host: reload.istio.deckhouse.io
    http:
      paths:
        - path: /fake-path-to-trigger-ingress-controller-config-reload-{{ $remoteRootCAs | toYaml | sha256sum }}
          backend:
            serviceName: fakeservice
            servicePort: https
{{- end }}
