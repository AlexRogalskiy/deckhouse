{{- if .Values.istio.federation.enabled }}
  {{- range $federation := .Values.istio.internal.federations }}
    {{- range $publicService := $federation.publicServices }}
---
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: {{ $federation.name }}-{{ $publicService.hostname | replace "." "-" }}
  namespace: d8-{{ $.Chart.Name }}
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
spec:
  hosts:
  - {{ $publicService.hostname | quote }}
  location: MESH_INTERNAL
  ports:
  - name: http1
    number: {{ $publicService.port }}
    protocol: http
  resolution: DNS
  addresses:
  - 169.254.40.20
  endpoints:
      {{- range $ingressGateway := $federation.ingressGateways }}
  - address: {{ $ingressGateway.address | quote }}
    ports:
      http1: {{ $ingressGateway.port }}
      {{- end }}
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ $federation.name }}-{{ $publicService.hostname | replace "." "-" }}
  namespace: d8-{{ $.Chart.Name }}
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
spec:
  host: {{ $publicService.hostname | quote }}
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    {{- end }}
  {{- end }}
{{- end }}
