{{ define "dex-authenticator-config" }}
  - id: {{ .name }}-{{ .namespace }}-dex-authenticator
    name: {{ .name }}-{{ .namespace }}-dex-authenticator
    secret: {{ .credentials.appDexSecret }}
    redirectURIs:
    - https://{{ .spec.applicationDomain }}/dex-authenticator/callback
{{ end }}

{{- $context := . }}
{{- range $crd := $context.Values.userAuthn.internal.dexAuthenticatorCRDs }}
  {{- if not $crd.useKubernetesAppKey }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $crd.name }}-{{ $crd.namespace }}-dex-client-app
  namespace: d8-{{ $context.Chart.Name }}
{{ include "helm_lib_module_labels" (list $context (dict "app" "dex-authenticator")) | indent 2 }}
data:
  config.yaml: |
{{ include "dex-authenticator-config" $crd | b64enc | indent 4 }}
  {{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: dex-authenticator-{{ $crd.name }}
  namespace: {{ $crd.namespace }}
{{ include "helm_lib_module_labels" (list $context (dict "app" "dex-authenticator")) | indent 2 }}
data:
  {{- if $crd.useKubernetesAppKey }}
  client-secret: {{ $context.Values.userAuthn.internal.kubernetesDexClientAppSecret | b64enc }}
  {{- else }}
  client-secret: {{ $crd.credentials.appDexSecret | b64enc }}
  {{- end }}
  cookie-secret: {{ $crd.credentials.cookieSecret | b64enc }}
{{- end }}
