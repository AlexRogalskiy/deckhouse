{{ define "dex-authenticator-config" }}
  - id: {{ .name }}-{{ .namespace }}-dex-authenticator
    name: {{ .name }}-{{ .namespace }}-dex-authenticator
    secret: {{ .credentials.appDexSecret }}
  {{- if .spec.allowedGroups }}
    allowedGroups:
    {{- range $group := .spec.allowedGroups }}
    - {{ $group }}
    {{- end }}
  {{- end }}
    redirectURIs:
    - https://{{ .spec.applicationDomain }}/dex-authenticator/callback
{{ end }}

{{- $context := . }}
{{ $namespaces := list }}
{{- range $crd := $context.Values.userAuthn.internal.dexAuthenticatorCRDs }}
  {{- if not $crd.useKubernetesAppKey }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $crd.name }}-{{ $crd.namespace }}-dex-client-app
  namespace: d8-{{ $context.Chart.Name }}
{{ include "helm_lib_module_labels" (list $context (dict "app" "dex-authenticator")) | indent 2 }}
data:
  config.yaml: |
{{ include "dex-authenticator-config" $crd | b64enc | indent 4 }}
  {{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: dex-authenticator-{{ $crd.name }}
  namespace: {{ $crd.namespace }}
{{ include "helm_lib_module_labels" (list $context (dict "app" "dex-authenticator")) | indent 2 }}
data:
  {{- if $crd.useKubernetesAppKey }}
  client-secret: {{ $context.Values.userAuthn.internal.kubernetesDexClientAppSecret | b64enc }}
  {{- else }}
  client-secret: {{ $crd.credentials.appDexSecret | b64enc }}
  {{- end }}
  cookie-secret: {{ $crd.credentials.cookieSecret | b64enc }}

  {{- if not (has $crd.namespace $namespaces) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-dex-authenticator
  namespace: {{ $crd.namespace }}
{{ include "helm_lib_module_labels" (list $context (dict "app" "dex-authenticator")) | indent 2 }}
type: kubernetes.io/dockercfg
data:
  .dockercfg: {{ $context.Values.global.modulesImages.registryDockercfg }}
    {{- $namespaces = append $namespaces $crd.namespace }}
  {{- end }}
{{- end }}
