# email = config, баг в dex
{{- $context := . }}
{{- range $provider := $context.Values.userAuthn.providers }}
---
apiVersion: dex.coreos.com/v1
kind: Connector
metadata:
  name: {{ $provider.id | quote }}
  namespace: d8-{{ $context.Chart.Name }}
{{ include "helm_lib_module_labels" (list $context (dict "app" "dex")) | indent 2 }}
id: {{ $provider.id | quote }}
name: {{ $provider.name | quote }}
  {{- if eq $provider.type "Github" }}
type: github
email:
  clientID: {{ $provider.github.clientID | quote }}
  clientSecret: {{ $provider.github.clientSecret | quote }}
  redirectURI: https://{{ include "helm_lib_module_public_domain" (list $context "dex") }}/callback
  orgs:
    {{- range $org := $provider.github.orgs }}
  - name: {{ $org.name | quote }}
      {{- if $org.teams }}
    teams:
        {{- range $team := $org.teams }}
    - {{ $team | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- if $provider.github.teamNameField }}
  teamNameField: {{ $provider.teamNameFiled }}
    {{- end }}
  useLoginAsID: {{ $provider.github.useLoginAsID | default false }}
  loadAllGroups: {{ $provider.github.loadAllGroups | default false }}

  {{- else if  eq $provider.type "Gitlab" }}
type: gitlab
email:
  baseURL: {{ $provider.gitlab.baseURL | quote }}
  clientID: {{ $provider.gitlab.clientID | quote }}
  clientSecret: {{ $provider.gitlab.clientSecret | quote }}
  redirectURI: https://{{ include "helm_lib_module_public_domain" (list $context "dex") }}/callback
    {{- if $provider.gitlab.groups }}
  groups:
      {{- range $group := $provider.gitlab.groups }}
  - {{ $group | quote }}
      {{- end }}
    {{- end }}

  {{- else if eq $provider.type "LDAP" }}
type: ldap
email:
  host: {{ $provider.ldap.host | quote }}
  insecureSkipVerify: {{ $provider.ldap.insecureSkipVerify | default false }}
    {{- if $provider.ldap.ca }}
  rootCAData: {{ $provider.ldap.ca | b64enc }}
    {{- end }}
  bindDN: {{ $provider.ldap.bindDN | quote }}
  bindPW: {{ $provider.ldap.bindPW | quote }}
  startTLS: {{ $provider.ldap.startTLS | default false }}
  userSearch:
{{ $provider.ldap.userSearch | toYaml | indent 2 }}
  groupSearch:
{{ $provider.ldap.groupSearch | toYaml | indent 2 }}
  usernamePrompt: "LDAP username"

  {{- else if eq $provider.type "OIDC" }}
type: oidc
email:
  issuer: {{ $provider.oidc.issuer | quote }}
  clientID: {{ $provider.oidc.clientID | quote }}
  clientSecret: {{ $provider.oidc.clientSecret | quote }}
  redirectURI: https://{{ include "helm_lib_module_public_domain" (list $context "dex") }}/callback
  basicAuthUnsupported: {{ $provider.oidc.basicAuthUnsupported | default false }}
  insecureSkipEmailVerified: {{ $provider.oidc.insecureSkipEmailVerified | default false }}
  getUserInfo: {{ $provider.oidc.getUserInfo | default false }}
  userIDKey: {{ $provider.oidc.userIDKey | default "sub" | quote }}
  userNameKey: {{ $provider.oidc.userNameKey | default "name" | quote }}
    {{- if $provider.oidc.scopes }}
  scopes:
{{ $provider.oidc.scopes | toYaml | indent 2 }}
    {{- end }}
  usernamePrompt: "OIDC username"

  {{- else if eq $provider.type "Crowd" }}
type: atlassian-crowd
email:
  baseURL: {{ $provider.crowd.baseURL | quote }}
  clientID: {{ $provider.crowd.clientID | quote }}
  clientSecret: {{ $provider.crowd.clientSecret | quote }}
    {{- if $provider.crowd.groups }}
  groups:
{{ $provider.crowd.groups | toYaml | indent 2 }}
    {{- end }}
  usernamePrompt: "Crowd username"
  {{- else }}
{{ printf "Unknown provider type %s" $provider.type | fail }}
  {{- end }}

{{- end }}
