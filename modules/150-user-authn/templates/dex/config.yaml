{{- define "dex_conf" }}
  {{- $context := . }}
  issuer: https://{{ include "helm_lib_module_public_domain" (list $context "dex") }}/
  storage:
    type: kubernetes
    config:
      inCluster: true
  web:
    http: 0.0.0.0:5556
  frontend:
    theme: "coreos"
    issuer: "Kubernetes Dex"
    issuerUrl: "https://{{ include "helm_lib_module_public_domain" (list $context "dex") }}"
    logoUrl: "https://kubernetes.io/images/favicon.png"
  expiry:
    authRequests: "1h"
    signingKeys: "6h"
    idTokens: {{ $context.Values.userAuthn.idTokenTTL | default "10m" | quote }}
  logger:
    level: debug
    format: json
  oauth2:
    responseTypes: ["code", "token", "id_token"]
    skipApprovalScreen: true
  {{- if $context.Values.userAuthn.internal.dexUsersCRDs }}
  enablePasswordDB: true
  {{- end }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: dex
  namespace: d8-{{ .Chart.Name }}
{{ include "helm_lib_module_labels" (list . (dict "app" "dex")) | indent 2 }}
data:
  config.yaml: |-
{{ include "dex_conf" . | b64enc | indent 4 }}
