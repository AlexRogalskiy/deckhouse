#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
   configVersion: v1
   beforeHelm: 10
   kubernetes:
   - name: endpoints
     apiVersion: v1
     kind: Endpoints
     executeHookOnEvent: ["Added", "Modified"]
     group: main
     keepFullObjectsInMemory: false
     nameSelector:
       matchNames: ["kubernetes"]
     namespace:
       nameSelector:
         matchNames: ["default"]
     jqFilter: "[ (.subsets // []) | .[].addresses[].ip]"
   - name: service
     apiVersion: v1
     kind: Service
     executeHookOnEvent: ["Added", "Modified"]
     group: main
     keepFullObjectsInMemory: false
     nameSelector:
       matchNames: ["kubernetes"]
     namespace:
       nameSelector:
         matchNames: ["default"]
     jqFilter: ".spec.ports[0].targetPort"
EOF
}


function __main__(){
  if [[ $(values::get userAuthn.publishAPI.enable) != "true" ]]; then
    values::unset userAuthn.internal.kubernetesApiserverAddresses
    values::unset userAuthn.internal.kubernetesApiserverTargetPort
    return 0
  fi

  values::set userAuthn.internal.kubernetesApiserverAddresses "$(context::get snapshots.endpoints.0.filterResult)"
  values::set userAuthn.internal.kubernetesApiserverTargetPort "$(context::get snapshots.service.0.filterResult)"
}


hook::run $@
