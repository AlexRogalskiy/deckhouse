#!/bin/bash

source /antiopa/shell_lib.sh

function __config__() {
  common_hooks::https::delete_not_matching_certificate_secret::config
}

function __main__() {
  if kubectl -n d8-user-authn get ing kubernetes-api -o json | jq -e '.metadata.annotations."certmanager.k8s.io/issuer"' ; then
    ingress_issuer_name=$(kubectl -n d8-user-authn get ing kubernetes-api -o json | jq -r '.metadata.annotations."certmanager.k8s.io/issuer"')
    secret_issuer_name=$(kubectl -n d8-user-authn get secret kubernetes-tls -o json | jq -r '.metadata.annotations."certmanager.k8s.io/issuer-name"')
    if [ "${ingress_issuer_name}" != "${secret_issuer_name}" ] ; then
      kubectl -n d8-user-authn delete certificate kubernetes-tls 2>/dev/null > /dev/null
      kubectl -n d8-user-authn delete secret kubernetes-tls 2>/dev/null >/dev/null
    fi
  fi
}

hook::run "$@"
