#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  echo '
{
  "onStartup": 1,
  "onKubernetesEvent": [
    {
      "kind": "secret",
      "name": "kubernetes-tls",
      "event": [
        "add",
        "update"
      ],
      "namespaceSelector": {
        "matchNames": [
          "d8-user-authn"
        ]
      },
      "jqFilter": ".data.\"ca.crt\""
    }
  ]
}'
}

function __main__() {
  if values::is_true userAuthn.publishAPI.enable ; then
    if [[ "$(values::get userAuthn.publishAPI.https.mode)" == "SelfSigned" ]] ; then
      if kubectl -n d8-user-authn get secret kubernetes-tls > /dev/null 2>/dev/null ; then
        selfsigned_publish_api_ca=$(kubectl -n d8-user-authn get secret kubernetes-tls -o json | jq '.data."ca.crt"' -r | base64 -d)
        values::set userAuthn.internal.publishedAPIKubeconfigGeneratorMasterCA "$selfsigned_publish_api_ca"
      fi
    fi
  fi
}

hook::run "$@"
