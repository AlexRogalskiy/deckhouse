---
title: "Управление control-plane"
---

Модуль [control-plane-manager]({{site.baseurl}}/modules/040-control-plane-manager/) реализует автоматически управляемый `control-plane`, управляет `etcd`, `kube-apiserver`, `kube-controller-manager` и `kube-scheduler`, в том числе:
- Осуществляет upgrade или downgrade компонентов Kubernetes control plane;
- Управляет членством etc-member’ов в etcd-кластере;
- Осуществляет обновлением сертификатов для компонентов `control-plane`.

Управляющие компоненты данного модуля автоматически запускаются на нодах c `label: node-role.kubernetes.io/master=””`. Далее они автоматически управляют конфигурационными файлами, сертификатами и манифестами компонентов `control-plane`. Параметры конфигурации кластера берутся из `ClusterConfiguration`, которая создается при инсталляции кластера.

## Изменение версий компонентов control-plane
При обновлении патч-версии (1.15.a -> 1.15.b) обновление происходит автоматически вместе с версией Deckhouse, в рамках выбранной минорной версии. Реализуется стратегия безопасного обновления — последовательно по одному узлу.

Желаемая минорная версия указывается вручную в настройках `control-plane`. Если указанная версия не соответствует текущей, запускается умная стратегия изменения версий компонентов `control-plane`:
- При upgrade:
  - Обновление происходит последовательно по одной минорной версии: 1.14 -> 1.15, 1.15 -> 1.16, и т.д.;
  - Переход на следующий шаг невозможен до тех пор, пока все компоненты `control-plane` не обновились до текущего шага обновления;
  - Обновление происходит максимум на одну версию новее, чем версии kubelet’ов на нодах.
- При downgrade:
  - Обновление происходит последовательно по одной минорной версии: 1.18 -> 1.17, 1.17 -> 1.16, и т.д.
  - Вверсия мастера не может быть старше версии ноды: downgrade не происходит, если версии kubelet’ов на нодах еще не даунгрейднуты.

## Поддерживаемые версии Kubernetes

| Версия Kubernetes | Обновление с нее |  Приведение кластера к версии
|---|---|---|
| 1.14 | Да | Нет |
| 1.15 | Да | Да |
| 1.16 | Да | Да |
| 1.17 | Да | Да |
| 1.18 | Нет | Да |

## Возможности модуля
### Масштабирование master-нод
Модуль предоставляет максимально простой и автоматический способ масштабирования узлов `control-plane` с помощью label `node-role.kubernetes.io/master=””`:
- Установка этого label на ноду приводит к выкату на нее компонентов `control-plane`, подключению нового узла `etcd` в кластер, а также перегенерации различных сертификатов и конфигурационных файлов для возможности использования нового мастера;
- При снятии этого label все компоненты `control-plane` автоматически удаляются с ноды, происходит перегенерация конфигурационных файлов и сертификатов, а также корректное исключение etcd-member'a.

**Важно:** при скейлинге узлов с 2-х до 1-го, – требуются дополнительные [ручные действия с etcd](/modules/040-control-plane-manager/), в остальных случаях все действия происходят автоматически.

### Поддержка single- и multi-master
Deckhouse поддерживает работу управляемого `control-plane` в конфигурации и *single-master* и *multi-master*.

В *single-master* инсталляции:
- `kube-apiserver` будет использовать только тот инстанс `etcd`, который размещен с ним на одной ноде;
- Для обработки API-вызовов от `scheduler` и `controller-manager` – `kube-apiserver` будет расположен на localhost.

При использованиии multi-master, компоненты `control-plane` будут автоматически развернуты в отказоустойчивом режиме:
- `kube-apiserver` будет настроен так, чтобы работать со всеми инстансами etcd.
-Ддля обработки API-вызовов от `scheduler` и `controller-manager` – на каждом мастере на localhost будет развернут дополнительный прокси-сервер, который по умолчанию обращается к локальному инстансу `kube-apiserver`, а если он недоступен, то будут последовательно опрошены остальные реплики `kube-apiserver`.

### Работа с сертификатами
Модуль автоматически управляет ssl-сертификатами для компонентов `control-plane`:
- Серверными сертификатами для `kube-apiserver` и `etcd`;
- Всеми клиентскими сертификатами для подключения компонентов `control-plane` друг к другу.

Также есть возможность добавить дополнительные SAN в сертификаты, это дает возможность быстро и просто добавлять дополнительные “точки входа” в API Kubernetes.

### Прямой доступ к API
Deckhouse поддерживает два способа организации прямого доступа к Kubernetes API:
- Прямой доступ через внешний IP-адрес мастер-узла или узлов (если используется *multi-master*). По умолчанию `kube-apiserver` слушает только на HostIP, обычно являющимся internal-адресом узла.
- С использованием `LoadBalancer`. Возможно заказать отдельный `LoadBalancer` в облачных инсталляциях для целей доступа к .Kubernetes API.

## Особенности компонентов `control-plane` от Фланта
В Deckhouse были расширены возможности компонентов control-plane:
- Добавлена возможность настройки OIDC-провайдера и webhook-авторизации. Аутентификация и авторизация при доступе к компонентам `control-plane` автоматически настраивается через модули [user-authn](/modules/150-user-authn/) и [user-authz](/modules/140-user-authz/);
- Мониторинг компонентов `control-plane` реализован в [отдельном модуле](/modules/340-monitoring-kubernetes-control-plane/) Deckhouse;
- В `kube-controller-manager` добавлена поддержка Ceph (rbd) без CSI;
- В `kube-apiserver` добавлено специальное логирование, когда клиент обращается в API с сертификатом, который скоро будет будет просрочен. Это позволяет заранее отследить клиентов API, у которых необходимо обновить сертификаты.

## Registry и доступность
Docker-образы всех компоненты Deckhouse, включая `control-plane`, хранятся в высокодоступном и геораспределенном Docker-registry.

Все Docker-образы, используемые в Deckhouse, скачиваются с фиксированного набора IP-адресов для удобства использования Deckhouse в изолированных контурах.
