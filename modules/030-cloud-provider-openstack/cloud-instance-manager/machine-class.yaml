apiVersion: machine.sapcloud.io/v1alpha1
kind: OpenStackMachineClass
metadata:
  name: {{ .nodeGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
  namespace: d8-cloud-instance-manager
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
spec:
  region: {{ .Values.nodeManager.internal.cloudProvider.openstack.connection.region | quote }}
  availabilityZone: {{ .zoneName }}
  flavorName: {{ .nodeGroup.instanceClass.flavorName }}
  imageName: {{ .nodeGroup.instanceClass.imageName }}
  networks:
  {{- $networks := list }}
  {{- if hasKey .nodeGroup.instanceClass "additionalNetworks" }}
    {{- range $additionalNetwork := .nodeGroup.instanceClass.additionalNetworks }}
      {{- $networks = append $networks $additionalNetwork }}
    {{- end }}
  {{- end }}
  {{- $networks = prepend $networks .nodeGroup.instanceClass.mainNetwork }}
  {{- range $networks }}
  - name: {{ . | quote }}
    {{- if has . $.Values.nodeManager.internal.cloudProvider.openstack.internalNetworkNames }}
      {{- if eq $.Values.nodeManager.internal.cloudProvider.openstack.podNetworkMode "DirectRoutingWithPortSecurityEnabled" }}
    podNetwork: true
      {{- end }}
    {{- end }}
  {{- end }}
  podNetworkCidr: {{ .Values.global.discovery.podSubnet }}
{{- if hasKey .Values.nodeManager.internal.cloudProvider.openstack "instances" }}
  {{- if hasKey .Values.nodeManager.internal.cloudProvider.openstack.instances "sshKeyPairName" }}
  keyName: {{ .Values.nodeManager.internal.cloudProvider.openstack.instances.sshKeyPairName }}
  {{- end }}
  {{- if or (hasKey .Values.nodeManager.internal.cloudProvider.openstack.instances "securityGroups") (hasKey .nodeGroup.instanceClass "securityGroups") }}
  securityGroups:
    {{- range .Values.nodeManager.internal.cloudProvider.openstack.instances.securityGroups }}
  - {{ . }}
    {{- end }}
    {{- range .nodeGroup.instanceClass.securityGroups }}
  - {{ . }}
    {{- end }}
  {{- end }}
{{- end }}
{{- if hasKey .nodeGroup.instanceClass "rootDiskSize" }}
  rootDiskSize: {{ .nodeGroup.instanceClass.rootDiskSize }}
{{- end }}
  tags:
    # These tags are mandatory as the safety controller uses them to identify VMs created by this controller.
    kubernetes.io-cluster-deckhouse-{{ .Values.global.discovery.clusterUUID }}: "1"
    kubernetes.io-role-deckhouse-{{ .nodeGroup.name }}-{{ .zoneName }}: "1"
  secretRef:
    namespace: d8-cloud-instance-manager
    name: {{ .nodeGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
