#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    afterHelm: 10
    kubernetes:
    - name: ngs
      group: main
      queue: /modules/$(module::name::kebab_case)/update_ngs_statuses
      watchEvent: ["Added", "Modified"]
      apiVersion: deckhouse.io/v1alpha1
      kind: NodeGroup
      jqFilter: |
        .name = .metadata.name |
        if (.spec.cloudInstances|has("maxPerZone")) then
          .maxPerZone = .spec.cloudInstances.maxPerZone
        else . end |
        if (.spec.cloudInstances|has("minPerZone")) then
          .minPerZone = .spec.cloudInstances.minPerZone
        else . end |
        if (.spec.cloudInstances|has("zones")) then
          .zonesNum = (.spec.cloudInstances.zones | length)
        else . end
    - name: cloud_provider_secrets
      group: main
      queue: /modules/$(module::name::kebab_case)/update_ngs_statuses
      apiVersion: v1
      kind: Secret
      namespace:
        nameSelector:
          matchNames: [kube-system]
      nameSelector:
        matchNames: [d8-node-manager-cloud-provider]
      jqFilter: |
        {"zonesNum": (try(.data.zones | @base64d | fromjson) // [] | length)}
    - name: configuration_checksums_secret
      group: main
      queue: /modules/$(module::name::kebab_case)/update_ngs_statuses
      apiVersion: v1
      kind: Secret
      namespace:
        nameSelector:
          matchNames: [d8-cloud-instance-manager]
      nameSelector:
        matchNames: [configuration-checksums]
      jqFilter: (.data // {}) | [to_entries[] | (.value |= (. | @base64d))] | from_entries
    - name: mds
      group: main
      queue: /modules/$(module::name::kebab_case)/update_ngs_statuses
      watchEvent: ["Added", "Modified"]
      apiVersion: machine.sapcloud.io/v1alpha1
      kind: MachineDeployment
      namespace:
        nameSelector:
          matchNames: [d8-cloud-instance-manager]
      jqFilter: '{"nodeGroup": .metadata.labels."instance-group", "replicas": .spec.replicas}'
    - name: instances
      group: main
      queue: /modules/$(module::name::kebab_case)/update_ngs_statuses
      watchEvent: ["Added", "Modified"]
      apiVersion: machine.sapcloud.io/v1alpha1
      kind: Machine
      namespace:
        nameSelector:
          matchNames: [d8-cloud-instance-manager]
      jqFilter: '{"nodeGroup": .metadata.labels."instance-group"}'
    - name: nodes
      group: main
      queue: /modules/$(module::name::kebab_case)/update_ngs_statuses
      apiVersion: v1
      kind: Node
      labelSelector:
        matchExpressions:
        - key: "node.deckhouse.io/group"
          operator: Exists
      jqFilter: |
        {
          "name": .metadata.name,
          "cloudInstanceGroup": .metadata.labels."node.deckhouse.io/group",
          "isReady": ([.status.conditions[] | select(.type == "Ready")][-1].status == "True"),
          "configurationChecksum": .metadata.annotations."node.deckhouse.io/configuration-checksum"
        }
EOF
}

function __main__() {
  default_zones_num="0"
  if context::has snapshots.cloud_provider_secrets.0; then
    default_zones_num="$(context::jq -r '.snapshots.cloud_provider_secrets[0].filterResult.zonesNum')"
  fi

  for i in $(context::jq -r '.snapshots.ngs | keys[]'); do
    ng_name="$(context::get snapshots.ngs.$i.filterResult.name)"

    desired_instances="$(context::jq -r --arg ng_name "${ng_name}" '[.snapshots.mds[] | select(.filterResult.nodeGroup == $ng_name) | .filterResult.replicas] | add // 0')"
    instances="$(context::jq -r --arg ng_name "${ng_name}" '[.snapshots.instances[] | select(.filterResult.nodeGroup | test("^" + $ng_name + "-.+"))] | length')"
    nodes="$(context::jq -r --arg ng_name "${ng_name}" '[.snapshots.nodes[] | select(.filterResult.cloudInstanceGroup == $ng_name)] | length')"
    ready_nodes="$(context::jq -r --arg ng_name "${ng_name}" '[.snapshots.nodes[] | select(.filterResult.cloudInstanceGroup == $ng_name and .filterResult.isReady)] | length')"

    ng_checksum="$(context::jq --arg ng_name "$ng_name" -r '.snapshots.configuration_checksums_secret[0].filterResult[$ng_name]')"
    uptodate_nodes_count="$(context::jq --arg ng_checksum "$ng_checksum" '[.snapshots.nodes[].filterResult | select(.configurationChecksum == $ng_checksum)] | length')"

    # shellcheck disable=SC2016
    status_patch="$(context::jq -c \
      --arg i $i \
      --arg default_zones_num $default_zones_num \
      --arg desired_instances_num "$desired_instances" \
      --arg instances_num "$instances" \
      --arg nodes_num "$nodes" \
      --arg ready_nodes_num "$ready_nodes" \
      --arg uptodate_nodes_count "$uptodate_nodes_count" \
      '.snapshots.ngs[$i | tonumber].filterResult |
        if .spec.nodeType == "Cloud" and $default_zones_num == "0" then
        {
          "desired": ($desired_instances_num | tonumber),
          "instances": ($instances_num | tonumber),
          "nodes": ($nodes_num | tonumber),
          "ready": ($ready_nodes_num | tonumber),
          "upToDate": ($uptodate_nodes_count | tonumber)
        }
        elif .spec.nodeType == "Cloud" then
        {
          "max": (.maxPerZone * (.zonesNum // ($default_zones_num | tonumber))),
          "min": (.minPerZone * (.zonesNum // ($default_zones_num | tonumber))),
          "desired": ($desired_instances_num | tonumber),
          "instances": ($instances_num | tonumber),
          "nodes": ($nodes_num | tonumber),
          "ready": ($ready_nodes_num | tonumber),
          "upToDate": ($uptodate_nodes_count | tonumber)
        }
        else
        {
          "nodes": ($nodes_num | tonumber),
          "ready": ($ready_nodes_num | tonumber),
          "upToDate": ($uptodate_nodes_count | tonumber)
        }
        end
    ')"

    kubernetes::status::patch "" "deckhouse.io/v1alpha1" "nodegroups" "${ng_name}" "${status_patch}"
  done
}

hook::run "$@"
