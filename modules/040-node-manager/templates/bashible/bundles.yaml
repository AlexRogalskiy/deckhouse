{{- /* deepCopy imitation */ -}}
{{- define "tpl_context_common_yaml" -}}
  {{- $context := . }}

  {{- $normal := dict }}
  {{- $_ := set $normal "bootstrapTokenPath" "/var/lib/bashible/bootstrap-token" }}
  {{- $_ := set $normal "apiserverEndpoints" $context.Values.nodeManager.internal.clusterMasterAddresses }}
  {{- $_ := set $normal "clusterDomain" $context.Values.global.discovery.clusterDomain }}
  {{- $_ := set $normal "clusterDNSAddress" $context.Values.global.discovery.clusterDNSAddress }}
  {{- $_ := set $normal "kubernetesCA" $context.Values.nodeManager.internal.kubernetesCA }}

  {{- $tpl_context_common := dict }}
  {{- $_ := set $tpl_context_common "runType" "Normal" }}
  {{- $_ := set $tpl_context_common "Template" $context.Template }}
  {{- $_ := set $tpl_context_common "normal" $normal }}

  {{- $tpl_context_common | toYaml }}
{{- end -}}

{{- $common_steps_pattern := "candi/bashible/common-steps/%s/*.sh.tpl" }}
{{- $bundle_steps_pattern := "candi/bashible/bundles/%s/%s/*.sh.tpl" }}

{{- $cloud_provider_common_steps_pattern := "" }}
{{- $cloud_provider_bundle_steps_pattern := "" }}
{{- if hasKey $.Values.nodeManager.internal "cloudProvider" }}
  {{- $cloud_provider_common_steps_pattern = (list "candi/cloud-providers/" $.Values.nodeManager.internal.cloudProvider.type "/bashible/common-steps/%s/*.sh.tpl" | join "") }}
  {{- $cloud_provider_bundle_steps_pattern = (list "candi/cloud-providers/" $.Values.nodeManager.internal.cloudProvider.type "/bashible/bundles/%s/%s/*.sh.tpl" | join "") }}
{{- end }}

{{- range $bundle := list "ubuntu-18.04" "centos-7" }}
  {{- range $ng := $.Values.nodeManager.internal.nodeGroups }}
---
apiVersion: v1
kind: Secret
metadata:
  name: bashible-bundle-{{ $bundle }}-{{ $ng.name }}
  namespace: d8-cloud-instance-manager
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
type: Opaque
data:
    {{- $tpl_context := (include "tpl_context_common_yaml" $ | fromYaml) }}
    {{- $_ := set $tpl_context "bundle" $bundle }}
    {{- $_ := set $tpl_context "kubernetesVersion" $ng.kubernetesVersion }}
    {{- $_ := set $tpl_context "nodeGroup" $ng }}

    {{- range $step_file, $_ := $.Files.Glob (printf $common_steps_pattern "node-group") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}

    {{- range $step_file, $_ := $.Files.Glob (printf $bundle_steps_pattern $bundle "node-group") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}

    {{- if hasKey $.Values.nodeManager.internal "cloudProvider" }}
      {{- $_ := set $tpl_context "cloudProvider" $.Values.nodeManager.internal.cloudProvider }}

      {{- range $step_file, $_ := $.Files.Glob (printf $cloud_provider_common_steps_pattern "node-group") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
      {{- end }}

      {{- range $step_file, $_ := $.Files.Glob (printf $cloud_provider_bundle_steps_pattern $bundle "node-group") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
      {{- end }}

    {{- end }}
  {{- end }}

  {{- range $kubernetes_version := list "1.14" "1.15" "1.16" }}
---
apiVersion: v1
kind: Secret
metadata:
  name: bashible-bundle-{{ $bundle }}-{{ $kubernetes_version }}
  namespace: d8-cloud-instance-manager
{{ include "helm_lib_module_labels" (list $) | indent 2 }}
type: Opaque
data:
    {{- $tpl_context := (include "tpl_context_common_yaml" $ | fromYaml) }}
    {{- $_ := set $tpl_context "bundle" $bundle }}
    {{- $_ := set $tpl_context "kubernetesVersion" $kubernetes_version }}

    {{- range $step_file, $_ := $.Files.Glob (printf $common_steps_pattern "all") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}

    {{- range $step_file, $_ := $.Files.Glob (printf $bundle_steps_pattern $bundle "all") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
    {{- end }}

    {{- if hasKey $.Values.nodeManager.internal "cloudProvider" }}
      {{- $_ := set $tpl_context "cloudProvider" $.Values.nodeManager.internal.cloudProvider }}

      {{- range $step_file, $_ := $.Files.Glob (printf $cloud_provider_common_steps_pattern "all") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
      {{- end }}

      {{- range $step_file, $_ := $.Files.Glob (printf $cloud_provider_bundle_steps_pattern $bundle "all") }}
{{ trimSuffix ".tpl" (base $step_file) | indent 2 }}: {{ tpl ($.Files.Get $step_file) $tpl_context | b64enc }}
      {{- end }}

    {{- end }}
  {{- end }}
{{- end }}
