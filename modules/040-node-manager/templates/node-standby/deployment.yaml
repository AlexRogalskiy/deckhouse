{{- range $ng := .Values.nodeManager.internal.standbyNodeGroups }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: standby-{{ $ng.name }}
  namespace: d8-cloud-instance-manager
{{ include "helm_lib_module_labels" (list $ (dict "app" "node-standby")) | indent 2 }}
spec:
  selector:
    matchLabels:
      app: node-standby
      ng: {{ $ng.name }}
  revisionHistoryLimit: 0
  replicas: {{ $ng.standby }}
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: node-standby
        ng: {{ $ng.name }}
    spec:
      imagePullSecrets:
      - name: deckhouse-registry
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app: node-standby
                ng: {{ $ng.name }}
            topologyKey: kubernetes.io/hostname
      nodeSelector:
        node.deckhouse.io/group: {{ $ng.name }}
      priorityClassName: standby
      tolerations:
{{ $ng.taints | toYaml | indent 8 }}
      containers:
      - name: reserve-resources
        image: "{{ $.Values.global.modulesImages.registry }}/common/pause:{{ $.Values.global.modulesImages.tags.common.pause }}"
        resources:
          requests:
            cpu: {{ $ng.reserveCPU | quote }}
            memory: {{ $ng.reserveMemory | quote }}
{{- end }}
