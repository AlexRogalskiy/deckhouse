- name: d8.monitoring-custom.migrate-domain-group
  rules:
  - alert: D8DeprecatedNodeSelectorOrTolerationFoundInCluster
    expr: |
      count(ALERTS{alertname=~"D8DeprecatedNodeSelectorOrTolerationFound", alertstate="firing"}) > 0
    labels:
      tier: cluster
      d8_component: monitoring-custom
      d8_module: monitoring-custom
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_alert_type: "group"
      summary: Controllers requiring migration has been found in cluster.
      description: |
        What exactly needs migration can be found in linked alerts.

- name: d8.monitoring-custom.migrate-domain
  rules:
  - alert: D8DeprecatedNodeSelectorOrTolerationFound
    expr: max(migrate_domain_resources == 1) by (controller, namespace, name) == 1
    labels:
      d8_component: monitoring-custom
      d8_module: monitoring-custom
      severity_level: "6"
      tier: cluster
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_grouped_by__d8_monitoring_custom_migrate_domain_group: "D8DeprecatedNodeSelectorOrTolerationFoundInCluster,tier=cluster,prometheus=deckhouse"
      summary: "{{ $labels.controller }} {{ $labels.name }} needs migration"
      description: |-
        {{ $labels.controller }} `{{ $labels.name }}` in Namespace {{ $labels.namespace }}
        uses old `nodeSelector` *node-role.flant.com/`(frontend|system)`*
        or old `tolerations` *dedicated.flant.com*  with values `(frontend|system)`

        Domain `flant.com` in this keys is going to be changed to `deckhouse.io`.

        Update current resource:
        1. Change `nodeSelector` to `node-role.deckhouse.io/(frontend|system)`
        1. Set additional `toleration` `dedicated.deckhouse.io=(frontend|system)`

        [Documentation is here](https://github.com/deckhouse/deckhouse/blob/master/modules/040-node-manager/docs/README.md#%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0-%D0%B2%D1%8B%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BD%D0%BE%D0%B4-%D0%BF%D0%BE%D0%B4-%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8)
