- name: kubernetes.extended-monitoring.node
  rules:
  - alert: NodeDiskBytesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_size_bytes - node_filesystem_avail_bytes)
          /
          node_filesystem_size_bytes
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_bytes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-bytes-warning"})
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-bytes-warning\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: NodeDiskBytesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_size_bytes - node_filesystem_avail_bytes)
          /
          node_filesystem_size_bytes
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_bytes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-bytes-critical"})
      )
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-bytes-critical\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: NodeDiskInodesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_files - node_filesystem_files_free)
          /
          node_filesystem_files
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_inodes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-inodes-warning"})
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-inodes-warning\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: NodeDiskInodesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_files - node_filesystem_files_free)
          /
          node_filesystem_files
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_inodes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-inodes-critical"})
      )
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-inodes-critical\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: LoadAverageHigh
    expr: >-
      (
        sum by (node) (avg_over_time(node_load1[30m]))
        /
        count by (node) (node_cpu_seconds_total{mode="idle"})
      ) > on (node) group_left() (
        max by (node) (extended_monitoring_node_threshold{threshold="load-average-warning"})
      )
    for: 30m
    labels:
      impact: critical
      likelihood: possible
    annotations:
      polk_flant_com_markup_format: markdown
      description: |-
        Последние 30 минут load average на ноде {{ $labels.node }} не опускался ниже {{ printf "extended_monitoring_node_threshold{threshold=\"load-average-warning\", node=\"%s\"}" $labels.node | query | first | value }} в пересчёте на одно ядро. В очереди к процессору больше процессов, чем тот может обработать, возможно какой-то процесс наплодил слишком много дочерних процессов или thread-ов или процессор просто перегружен.
      summary: >
        Load average на {{ $labels.node }} слишком велик.

  - alert: LoadAverageHigh
    expr: >-
      (
        sum by (node) (avg_over_time(node_load1[5m]))
        /
        count by (node) (node_cpu_seconds_total{mode="idle"})
      ) > on (node) group_left() (
        max by (node) (extended_monitoring_node_threshold{threshold="load-average-critical"})
      )
    for: 5m
    labels:
      impact: critical
      likelihood: likely
    annotations:
      polk_flant_com_markup_format: markdown
      description: |-
        Последние 5 минут Load average на ноде {{ $labels.node }} выше {{ printf "extended_monitoring_node_threshold{threshold=\"load-average-critical\", node=\"%s\"}" $labels.node | query | first | value }} в пересчёте на одно ядро. В очереди к процессору больше процессов, чем тот может обработать, возможно какой-то процесс наплодил слишком много дочерних процессов или thread-ов или процессор просто перегружен.
      summary: >
        Load average на {{ $labels.node }} слишком велик.
