- name: kubernetes.extended-monitoring.node
  rules:
  - alert: NodeDiskBytesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_size_bytes - node_filesystem_avail_bytes)
          /
          node_filesystem_size_bytes
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_bytes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-bytes-warning"})
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-bytes-warning\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: NodeDiskBytesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_size_bytes - node_filesystem_avail_bytes)
          /
          node_filesystem_size_bytes
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_bytes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-bytes-critical"})
      )
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-bytes-critical\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: NodeDiskInodesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_files - node_filesystem_files_free)
          /
          node_filesystem_files
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_inodes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-inodes-warning"})
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-inodes-warning\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%

  - alert: NodeDiskInodesUsage
    expr: |
      (
        max by (node, mountpoint) (
          (node_filesystem_files - node_filesystem_files_free)
          /
          node_filesystem_files
        ) * 100 unless (max by (node, mountpoint) ({__name__=~"kubelet_eviction_.+_inodes"})))
      > on (node) group_left()
      (
        max by (node) (extended_monitoring_node_threshold{threshold="disk-inodes-critical"})
      )
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: |-
        Node disk "{{$labels.device}}" on mountpoint "{{$labels.mountpoint}}" is using more than {{ printf "extended_monitoring_node_threshold{threshold=\"disk-inodes-critical\", node=\"%s\"}" $labels.node | query | first | value }}% of storage capacity.
        Currently at: {{ .Value }}%
