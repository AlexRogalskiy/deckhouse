#!/bin/bash

### Миграция 2019-05-14: https://github.com/deckhouse/deckhouse/merge_requests/783
#
# Этот хук нужен для изменения стратегии выката для extended-monitoring и решения проблемы с одновременной доступностью двух kub-state-metrics, что приводит к проблемам с алертами Prometheus

source /antiopa/shell_lib.sh

function __config__() {
  jo -p beforeHelm=15
}

function __main__ () {
  if kubectl -n kube-prometheus get deploy extended-monitoring  -o json | jq -e '. | select(.spec.strategy.type == "RollingUpdate") | .metadata.name' > /dev/null ; then
    kubectl -n kube-prometheus delete deploy extended-monitoring
  fi
}

hook::run $@
