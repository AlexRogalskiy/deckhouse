########################################################################################################################
# General mapping is:
#   name:value|type
#
# We use many labels, concateneted in name using # symbol, for example:
#   a#http#kube-nginx-ingress#test.k8s.dev.someproject.ru#404:1|c
#
# First letter's explanation can be found in `modules/400-nginx-ingress/images/controller/rootfs/etc/nginx/lua/statsd.lua` call() method
#####
# Examples of label values:
#   content_kind          regular, nginx, cacheable, non-cacheable
#   namespace             pult-production, kube-nginx-ingress
#   scheme                http
#   method                GET, POST, PUT, ...
#   vhost                 api.someproject.somedomain, api.someproject.somedomain, test.k8s.dev.someproject.ru
#   ingress               test, pult-servers-api
#   service               pult-servers-api-web, default-http-backend
#   service_port          80
#   location              /
#   backend               10.244.2.250
#   status                200, 404

mappings:

# --- requests ---
- match: ^ao#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_requests_total"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    scheme: "$4"
    method: "$5"
- match: ^ad#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_requests_total"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    scheme: "$8"
    method: "$9"

# --- responses ---
- match: ^bo#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_responses_total"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    status: "$4"
- match: ^bd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_responses_total"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    status: "$8"

# --- request time histogram ---
# Overall
- match: ^co#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_request_seconds_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    le: "$4"
- match: ^sco#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_request_seconds_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^cco#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_request_seconds_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
# Detail
- match: ^cd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_request_seconds_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    le: "$8"
- match: ^scd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_request_seconds_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
- match: ^ccd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_request_seconds_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- bytes sent histogram ---
# Overall
- match: ^do#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_sent_bytes_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    le: "$4"
- match: ^sdo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_sent_bytes_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^cdo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_sent_bytes_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
# Detail
- match: ^dd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_sent_bytes_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    le: "$8"
- match: ^cdd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_sent_bytes_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
- match: ^sdd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_sent_bytes_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- bytes received histogram ---
# Overall
- match: ^eo#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_received_bytes_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    le: "$4"
- match: ^seo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_received_bytes_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^ceo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_received_bytes_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
# Detail
- match: ^ed#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_received_bytes_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    le: "$8"
- match: ^sed#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_received_bytes_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
- match: ^ced#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_received_bytes_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- upstream response time histogram ---
# Overall
- match: ^fo#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_upstream_response_seconds_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    le: "$4"
- match: ^sfo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_upstream_response_seconds_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^cfo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_upstream_response_seconds_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
# Detail
- match: ^fd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_upstream_response_seconds_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    le: "$8"
- match: ^fd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_upstream_response_seconds_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
- match: ^fd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_upstream_response_seconds_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- upstream response time (lowres) histogram ---
# Overall
- match: ^go#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_lowres_upstream_response_seconds_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    le: "$4"
- match: ^sgo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_lowres_upstream_response_seconds_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^cgo#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_lowres_upstream_response_seconds_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
# Detail
- match: ^gd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_lowres_upstream_response_seconds_bucket"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
    le: "$8"
- match: ^sgd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_lowres_upstream_response_seconds_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"
- match: ^cgd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_lowres_upstream_response_seconds_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- upstream retries count ---
- match: ^ho#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_upstream_retries_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^hd#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_upstream_retries_count"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- upstream retries sum ---
- match: ^io#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_overall_upstream_retries_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
- match: ^id#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_detail_upstream_retries_sum"
  labels:
    content_kind: "$1"
    namespace: "$2"
    ingress: "$3"
    service: "$4"
    service_port: "$5"
    vhost: "$6"
    location: "$7"

# --- geohash ---
- match: ^jo#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 5m
  match_type: regex
  name: "ingress_nginx_overall_geohash_total"
  labels:
    content_kind: "$1"
    namespace: "$2"
    vhost: "$3"
    geohash: "$4"
    place: "$5"

# --- per backend ---
# Histogram
- match: ^ka#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 5m
  match_type: regex
  name: "ingress_nginx_detail_backend_lowres_upstream_response_seconds_bucket"
  labels:
    namespace: "$1"
    ingress: "$2"
    service: "$3"
    service_port: "$4"
    vhost: "$5"
    location: "$6"
    pod_ip: "$7"
    le: "$8"
- match: ^ska#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 5m
  match_type: regex
  name: "ingress_nginx_detail_backend_lowres_upstream_response_seconds_sum"
  labels:
    namespace: "$1"
    ingress: "$2"
    service: "$3"
    service_port: "$4"
    vhost: "$5"
    location: "$6"
    pod_ip: "$7"
- match: ^ska#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 5m
  match_type: regex
  name: "ingress_nginx_detail_backend_lowres_upstream_response_seconds_count"
  labels:
    namespace: "$1"
    ingress: "$2"
    service: "$3"
    service_port: "$4"
    vhost: "$5"
    location: "$6"
    pod_ip: "$7"

- match: ^kb#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 5m
  match_type: regex
  name: "ingress_nginx_detail_backend_responses_total"
  labels:
    namespace: "$1"
    ingress: "$2"
    service: "$3"
    service_port: "$4"
    vhost: "$5"
    location: "$6"
    pod_ip: "$7"
    status_class: "${8}xx"
- match: ^kc#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)#([^#]+)$
  ttl: 5m
  match_type: regex
  name: "ingress_nginx_detail_backend_upstream_bytes_received_sum"
  labels:
    namespace: "$1"
    ingress: "$2"
    service: "$3"
    service_port: "$4"
    vhost: "$5"
    location: "$6"
    pod_ip: "$7"

# --- default backend ---
- match: ^l#$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_default_backend_requests_total"

# --- buffer overflow ---
- match: ^m#$
  ttl: 1h
  match_type: regex
  name: "ingress_nginx_statsd_buffer_overflow_total"

# --- timers ---
- match: ^nr#([^#]+)$
  ttl: 1h
  match_type: regex
  match_metric_type: gauge
  name: "ingress_nginx_statsd_running_timers_quantity"
  labels:
    worker_id: "$1"
- match: ^np#([^#]+)$
  ttl: 1h
  match_type: regex
  match_metric_type: gauge
  name: "ingress_nginx_statsd_pending_timers_quantity"
  labels:
    worker_id: "$1"

# --- drop by default ---
- match: .
  ttl: 1h
  match_type: regex
  action: drop
  name: "dropped"
