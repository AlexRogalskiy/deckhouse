Модуль metallb
==============

Модуль устанавливает в кластер [MetalLB](https://metallb.universe.tf/) для реализации механизма `LoadBalancer` у сервисов. Применим в кластерах bare-metal.

Конфигурация
------------

### Включение модуля

Модуль по-умолчанию **выключен**. Для включения добавьте в CM `deckhouse`:

```yaml
data:
  metallbEnabled: "true"
```

### Параметры

Для настройки модуля предусмотрены следующие параметры в CM `deckhouse`:

* `speaker` — настройки компонента `speaker`, который реализует протокол публикации (`bgp` или `layer2` (LVS)) и направляет на свою ноду прикладной трафик сервисов.
    * `nodeSelector` — селектор нод, на которых будет работать DaemonSet speaker.
        * Обязательный параметр.
    * `tolerations` — противоядие против `taints` на нодах.
        * Опциональный параметр.
* `bgpPeers` — список внешних BGP-роутеров, которые будут работать с этим модулем.
    * Формат — массив [как у оригинального MetalLB](https://metallb.universe.tf/configuration/#bgp-configuration). Основные параметры:
        * `peer-address` — IP внешнего BGP-роутера.
        * `peer-asn` — номер автономки на внешнем BGP-роутере.
        * `my-asn` — номер автономки на вашем кластере.
        * `node-selector` — дополнительный псевдо-селектор, который реализуется приложением speaker-а. Говорит о том, с каких нод стоит устанавливать связь с внешними BGP-роутерами. Не путать с `speaker.nodeSelector` и  `nodeSelector`.
            * Опциональный параметр.
            * Формат — [`matchLabels` или `matchExpressions`](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#resources-that-support-set-based-requirements).
    * Если используется только протокол публикации сервисов `layer2`, то параметр — необязательный.
* `addressPools` — список диапазонов IP, которые будут выдаваться сервисам.
    * Формат — массив [как у оригинального MetalLB](https://metallb.universe.tf/configuration/#advanced-address-pool-configuration). Основные параметры:
        * `name` — имя пула, которое можно уточнять с помощью аннотации к сервису `metallb.universe.tf/address-pool: <name>`.
        * `protocol` — технология публикации сервисов, которую должен реализовать speaker. Варианты:
            * `bgp`.
            * `layer2` — использовать L2 LVS.
        * `addresses` — список диапазонов, где диапазон — это либо подсеть с маской, либо диапазон через "-".
* `nodeSelector` — селектор для основного контроллера. Как в Kubernetes в `spec.nodeSelector` у pod'ов.
    * Если ничего не указано — будет [использоваться автоматика](/README.md#выделение-узлов-под-определенный-вид-нагрузки).
    * Можно указать `false`, чтобы не добавлять никакой nodeSelector.
* `tolerations` — толерейшны для основного контроллера. Как в Kubernetes в `spec.tolerations` у pod'ов.
    * Если ничего не указано — будет [использоваться автоматика](/README.md#выделение-узлов-под-определенный-вид-нагрузки).
    * Можно указать `false`, чтобы не добавлять никакие toleration'ы.
