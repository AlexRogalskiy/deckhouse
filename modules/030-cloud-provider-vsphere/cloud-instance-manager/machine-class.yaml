apiVersion: machine.sapcloud.io/v1alpha1
kind: VsphereMachineClass
metadata:
  name: {{ .nodeGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
  namespace: d8-cloud-instance-manager
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
spec:
  region: {{ .Values.nodeManager.internal.cloudProvider.vsphere.region | quote }}
  zone:  {{ .zoneName | quote }}
  numCPUs: {{ .nodeGroup.instanceClass.numCPUs }}
  memory: {{ add .nodeGroup.instanceClass.memory (mod .nodeGroup.instanceClass.memory 4) }}
  rootDiskSize: {{ .nodeGroup.instanceClass.rootDiskSize }}
  template: {{ .nodeGroup.instanceClass.template | quote }}
  virtualMachineFolder: {{ .Values.nodeManager.internal.cloudProvider.vsphere.vmFolderPath | quote }}
  mainNetwork: {{ .nodeGroup.instanceClass.mainNetwork | quote }}
{{- if .nodeGroup.instanceClass.additionalNetworks }}
  additionalNetworks:
  {{- range .nodeGroup.instanceClass.additionalNetworks }}
  - {{ . | quote }}
  {{- end }}
{{- end }}
  datastore: {{ .nodeGroup.instanceClass.datastore | quote }}
{{- /* Откатить после окончания ***REMOVED***а */ -}}
{{- if or .nodeGroup.instanceClass.resourcePool .nodeGroup.instanceClass.resourcePoolForNewNodes }}
  resourcePool: {{ or .nodeGroup.instanceClass.resourcePool .nodeGroup.instanceClass.resourcePoolForNewNodes | quote }}
{{- end }}
  clusterNameTag: {{ .Values.global.discovery.clusterUUID }}
  nodeRoleTag: {{ .nodeGroup.name }}-{{ .zoneName }}
  sshKeys:
{{- range .Values.nodeManager.internal.cloudProvider.vsphere.sshKeys }}
  - {{ . | quote }}
{{- end }}
{{- if not .nodeGroup.instanceClass.runtimeOptions }}
{{ $_ := set .nodeGroup.instanceClass "runtimeOptions" dict }}
{{- end }}
  runtimeOptions:
    nestedHardwareVirtualization: {{ .nodeGroup.instanceClass.runtimeOptions.nestedHardwareVirtualization | default true }}
    resourceAllocationInfo:
{{- if .nodeGroup.instanceClass.runtimeOptions.cpuShares }}
      cpuShares: {{ .nodeGroup.instanceClass.runtimeOptions.cpuShares }}
{{- end }}
{{- if .nodeGroup.instanceClass.runtimeOptions.cpuLimit }}
      cpuLimit: {{ .nodeGroup.instanceClass.runtimeOptions.cpuLimit }}
{{- end }}
{{- if .nodeGroup.instanceClass.runtimeOptions.cpuReservation }}
      cpuReservation: {{ .nodeGroup.instanceClass.runtimeOptions.cpuReservation }}
{{- end }}
{{- if .nodeGroup.instanceClass.runtimeOptions.memoryShares }}
      memoryShares: {{ .nodeGroup.instanceClass.runtimeOptions.memoryShares }}
{{- end }}
{{- if .nodeGroup.instanceClass.runtimeOptions.memoryLimit }}
      memoryLimit: {{ .nodeGroup.instanceClass.runtimeOptions.memoryLimit }}
{{- end }}
      memoryReservation: {{ mul (div (add .nodeGroup.instanceClass.memory (mod .nodeGroup.instanceClass.memory 4)) 100) (.nodeGroup.instanceClass.runtimeOptions.memoryReservation | default 80) }}
  secretRef:
    namespace: d8-cloud-instance-manager
    name: {{ .nodeGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
