apiVersion: machine.sapcloud.io/v1alpha1
kind: VsphereMachineClass
metadata:
  name: {{ .instanceGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
  namespace: d8-{{ .Chart.Name }}
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
spec:
  region: {{ .Values.cloudInstanceManager.internal.cloudProvider.vsphere.region | quote }}
  zone:  {{ .zoneName | quote }}
  numCPUs: {{ .instanceGroup.instanceClass.numCPUs }}
  memory: {{ add .instanceGroup.instanceClass.memory (mod .instanceGroup.instanceClass.memory 4) }}
  rootDiskSize: {{ .instanceGroup.instanceClass.rootDiskSize }}
  template: {{ .instanceGroup.instanceClass.template | quote }}
  virtualMachineFolder: {{ .Values.cloudInstanceManager.internal.cloudProvider.vsphere.vmFolderPath | quote }}
  mainNetwork: {{ .instanceGroup.instanceClass.mainNetwork | quote }}
{{- if .instanceGroup.instanceClass.additionalNetworks }}
  additionalNetworks:
  {{- range .instanceGroup.instanceClass.additionalNetworks }}
  - {{ . | quote }}
  {{- end }}
{{- end }}
  datastore: {{ .instanceGroup.instanceClass.datastore | quote }}
{{- if .instanceGroup.instanceClass.resourcePool }}
  resourcePool: {{ .instanceGroup.instanceClass.resourcePool | quote }}
{{- end }}
  clusterNameTag: {{ .Values.global.discovery.clusterUUID }}
  nodeRoleTag: {{ .instanceGroup.name }}-{{ .zoneName }}
  sshKeys:
{{- range .Values.cloudInstanceManager.internal.cloudProvider.vsphere.sshKeys }}
  - {{ . | quote }}
{{- end }}
{{- if not .instanceGroup.instanceClass.runtimeOptions }}
{{ $_ := set .instanceGroup.instanceClass "runtimeOptions" dict }}
{{- end }}
  runtimeOptions:
    nestedHardwareVirtualization: {{ .instanceGroup.instanceClass.runtimeOptions.nestedHardwareVirtualization | default true }}
    resourceAllocationInfo:
{{- if not .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo }}
{{ $_ := set .instanceGroup.instanceClass.runtimeOptions "resourceAllocationInfo" dict }}
{{- end }}
{{- if .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.cpuShares }}
      cpuShares: {{ .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.cpuShares }}
{{- end }}
{{- if .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.cpuLimit }}
      cpuLimit: {{ .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.cpuLimit }}
{{- end }}
{{- if .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.cpuReservation }}
      cpuReservation: {{ .instanceGroup.instanceClass.runtimeOptions.cpuReservation }}
{{- end }}
{{- if .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.memoryShares }}
      memoryShares: {{ .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.memoryShares }}
{{- end }}
{{- if .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.memoryLimit }}
      memoryLimit: {{ .instanceGroup.instanceClass.runtimeOptions.resourceAllocationInfo.memoryLimit }}
{{- end }}
      memoryReservation: {{ mul (div (add .instanceGroup.instanceClass.memory (mod .instanceGroup.instanceClass.memory 4)) 100) (.instanceGroup.instanceClass.runtimeOptions.memoryReservation | default 80) }}
  secretRef:
    namespace: d8-{{ .Chart.Name }}
    name: {{ .instanceGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
