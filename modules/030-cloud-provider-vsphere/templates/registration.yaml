---
apiVersion: v1
kind: Secret
metadata:
  name: d8-node-manager-cloud-provider
  namespace: kube-system
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
type: Opaque
data:
  # obligatory
  type: {{ b64enc "vsphere" | quote }}
  zones: {{ .Values.cloudProviderVsphere.internal.zones | toJson | b64enc | quote }}
  instanceClassKind: {{ b64enc "VsphereInstanceClass" | quote }}
  machineClassKind: {{ b64enc "VsphereMachineClass" | quote }}

  # vsphere
  {{- $vsphereValues := dict }}
  {{- $_ := set $vsphereValues "server" .Values.cloudProviderVsphere.internal.server }}
  {{- $_ := set $vsphereValues "username" .Values.cloudProviderVsphere.internal.username }}
  {{- $_ := set $vsphereValues "password" .Values.cloudProviderVsphere.internal.password }}
  {{- $_ := set $vsphereValues "insecure" .Values.cloudProviderVsphere.internal.insecure }}
  {{- $_ := set $vsphereValues "regionTagCategory" .Values.cloudProviderVsphere.internal.regionTagCategory }}
  {{- $_ := set $vsphereValues "zoneTagCategory" .Values.cloudProviderVsphere.internal.zoneTagCategory }}
  {{- $_ := set $vsphereValues "region" .Values.cloudProviderVsphere.internal.region }}
  {{- $_ := set $vsphereValues "sshKey" .Values.cloudProviderVsphere.internal.sshKey }}
  {{- $_ := set $vsphereValues "vmFolderPath" .Values.cloudProviderVsphere.internal.vmFolderPath }}

  {{- if .Values.cloudProviderVsphere.internal.masterInstanceClass }}
    {{- $_ := set $vsphereValues "instanceClassDefaults" dict }}
    {{- $_ := set $vsphereValues.instanceClassDefaults "template" .Values.cloudProviderVsphere.internal.masterInstanceClass.template }}
    {{- $_ := set $vsphereValues.instanceClassDefaults "datastore" .Values.cloudProviderVsphere.internal.masterInstanceClass.datastore }}
    {{- $_ := set $vsphereValues.instanceClassDefaults "resourcePool" .Values.cloudProviderVsphere.internal.masterInstanceClass.resourcePool }}
    {{- if hasKey .Values.cloudProviderVsphere.internal "disableTimesync" }}
      {{- $_ := set $vsphereValues.instanceClassDefaults "disableTimesync" .Values.cloudProviderVsphere.internal.disableTimesync }}
    {{- else }}
      {{- $_ := set $vsphereValues.instanceClassDefaults "disableTimesync" true }}
    {{- end }}
  {{- end }}

  vsphere: {{ $vsphereValues | toJson | b64enc | quote }}
