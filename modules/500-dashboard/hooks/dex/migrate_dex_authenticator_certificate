#!/bin/bash

### Миграция 2019-09-20
# Удалить хук после переезда dashboard в неймспейс d8-dashboard

source /deckhouse/shell_lib_legacy.sh

function __config__() {
  echo '
{
  "afterHelm": 10,
  "onKubernetesEvent": [
    {
      "kind": "secret",
      "name": "ingress-tls",
      "event": [
        "add",
        "update"
      ],
      "namespaceSelector": {
        "matchNames": [
          "kube-system"
        ]
      }
    }
  ]
}'
}

function __main__() {
  if ! values::array_has global.enabledModules "user-authn"; then
    return 0
  fi

  if [[ "$(values::get dashboard.version)" == "2" ]]; then
    return 0
  fi

  if kubectl -n kube-system get secret ingress-tls > /dev/null 2>&1 ; then
    kubectl -n kube-system get secret ingress-tls -o json | jq 'include "remove_empty"; .metadata.namespace = "d8-dashboard" | remove_empty' | kubectl::replace_or_create
  fi
}

hook::run $@
