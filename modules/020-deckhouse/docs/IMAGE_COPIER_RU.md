# Копировальщик образов

Мы имеем несколько редакций deckhouse CE, EE и FE.
Клиент в какой-то момент времени может перестать пользоваться нашими услугами.
Логично было бы перевести клиента на CE редакцию, 
но клиент может активно использовать часть функционала, предоставленного в EE-редакции. 
Например, кластер развернут в Openstack. Если мы переключим клиента на CE-редакцию,
то кластер будет неработоспособен. Также после завершения оказания услуг, мы не хотим 
поставлять обновления deckhouse. Поэтому мы должны перепушить ВСЕ наши образы в registry клиента
и переключить deckhouse на репозиторий клиента.
Для упрощения данной задачи был написан скрипт перепушивания образов и хук, который несколько упрощает данный процесс.

# Как это работает?

Создается специальный секрет `images-copier-config` в неймспейсе `d8-system` 
c доступами к registry, в который будут перепушиваться образы.
В этом секрете мы указываем конечный адрес образа (с ТЕГОМ) deckhouse-контроллера.
Из-за технических особенностей НЕЛЬЗЯ использовать адрес имаджа с `/dev` в конце,
напремер: `client.registry/repo/deckhouse/dev:test`.
Хук добавляет в секрет текущие креды registry deckhouse и список всех образов модулей - `/deckhouse/modules/images_tags.json` 
Данный список генерируется при сборке и кладется в образ deckhouse.
Хук запускает джобу со скриптом копирования образов, монтирую секрет в контейнер пода. 
Если перепушивание завершилось успешно, то хук удаляет секрет, джобу и под.

# Последовательность действий

## Копирование образов 

- Запусти скрипт `../images/images-copier/generate-copier-secret.sh` указав креденшалы конечного registry для перепуша
  
  Пример: 
  `REPO_USER="u" REPO_PASSWORD='Pass"Word' IMAGE_WITH_TAG="client.registry/repo/deckhouse:test" ./generate-copier-secret.sh`

  Тег ОБЯЗАТЕЛЕН!!! Тег в принципе может быть любой, например: `rock-solid-1.24.7`. 
- На STDOUT будет выведено содержимое секрета, который нужно добавить в кластер и 
  две команды для переключения registry после перепушивания.
- Добавляем секрет `kubectl create -f - <<EOD ...`
- В кластере должна появится джоба `kubectl -n d8-system get job copy-images`
- Ждем пока все скопируется.
- Если перепушивание успешно завершилось, то джоба, под и секрет будут удалены из кластера, и в логах deckhouse появится сообщение:
  `Image copier ran successfully. Cleanup`

  Команда для проверки: `kubectl logs -n d8-system deployments/deckhouse | grep "Image copier ran successfully"`
- Если перепушивание завершилось неудачно, ни джоба, ни секрет, ни под не будут удалены, а в логах deckhouse будет следующее сообщение:
  `Image copier was failed. See logs into image copier job pod for additional information`

  Команда для проверки: `kubectl logs -n d8-system deployments/deckhouse | grep "Image copier was failed"`
  
  В этом случае можно посмотреть логи джобы, например, с помощью следующей команды:
  `kubectl -n d8-system logs jobs/copy-images`

  Перезапустить перепушивание можно добавлением/изменением аннотаций в секрете `d8-system/images-copier-config`

Внимание! Если удалить секрет, то джоба и поды будут удалены в не зависимости от состояния джобы.

## Переключение репозитория
Когда ты запускал `generate-copier-secret.sh` скрипт, то в выводе кроме секрета были две команды:
- первая меняет `deckhouse-registry` секрет
- меняет имя образа для deckhouse-controller.

Исполни их последовательно и дождись переката всех подов. 
Посмотреть какие образа сейчас используются:

```
kubectl get pods --all-namespaces -o jsonpath="{.items[*].spec.containers[*].image}" |\
tr -s '[[:space:]]' '\n' |\
sort |\
uniq -c
```
