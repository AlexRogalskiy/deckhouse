Модуль deckhouse
================

Модуль не устанавливает, но настраивает Deckhouse.

Конфигурация
------------

### Параметры

* `logLevel` — уровень логирования Deckhouse: 
    * Возможные варианты: `Debug`, `Info`, `Error`; 
    * По умолчанию `Info`.
* `bundle` — вариант поставки Deckhouse. Определяет включенные по умолчанию модули. 
    * Возможные варианты:
        * `Default` — включает рекомендованный набор модулей для работы кластера: мониторинга, контроля авторизации, организации работы сети и других потребностей. С актуальным списком можно ознакомиться [здесь](modules/values-default.yaml).
        * `Minimal` — минимально возможная поставка, которая включает единственный модуль (этот).
        * `Managed` - поставка для managed кластеров от облачных провайдеров, например Google Kubernetes Engine (GKE)
    * По умолчанию `Default`.
* `releaseChannel` — канал обновлений Deckhouse.
    * Возможные варианты в порядке возрастания стабильности обновлений: `Alpha`, `Beta`, `EarlyAccess`, `Stable`, `RockSolid`. 
### Пример конфига

```yaml
deckhouse: |
  logLevel: Debug
  bundle: Minimal
  releaseChannel: RockSolid
```

Автоматическая стабилизация релизного канала
--------------------------------------------
При указании в конфигурации параметра `releaseChannel` Deckhouse сам переключит image на соответствующий тег Docker-образа. Дополнительных действий со стороны пользователя не требуется.

**Внимание:** переключение не происходит мгновенно и зависит от обновлений Deckhouse.

<details>
  <summary>Логика работы:</summary><br>

Каждые 10 минут будет запускаться скрипт стабилизации канала обновлений:

* Если указанный канал обновлений соответствует тегу Docker-образа Deckhouse — ничего не произойдет;

* При смене канала обновлений на более стабильный (например с Alpha на EarlyAccess) будет произведен плавный переход.
  
  Сначала мы проверяем равенство [digest](https://success.docker.com/article/images-tagging-vs-digests) для тегов Docker-образов, соответствующих текущему каналу обновлений и ближайшему к нему более стабильному (в нашем примере это каналы Alpha и Beta).
  
  Если digest'ы равны, будет проверен следующий по очереди тег (в нашем примере соответствующий каналу обновлений EarlyAccess).
  
  В итоге Deckhouse будет переключен на более стабильный канал обновлений c digest'ом, равным текущему.

* Если указан менее стабильный канал обновлений, чем тот, который соответствует текущему тегу Docker-образа Deckhouse — мы сверим digest'ы соответствующие образам Docker для текущего канала обновлений и следующего менее стабильного (например хотим перейти на Alpha, и сейчас мы на EarlyAccess, — сравнивать будем EarlyAccess и Beta).

  Если digest не равны, Deckhouse будет переключен на следующий канал обновлений (в нашем случае на Beta). Это необходимо, чтобы не пропустить важные миграции, которые мы проводим при обновлении Deckhouse.
  
  Если digest равны, будет проверен следующий по убыванию стабильности канал обновлений (в нашем случае Alpha).
  
  Когда проверка дойдет до желаемого канала обновлений (в примере — Alpha), переключение Deckhouse произойдет независимо от равенства digest.
  
  
В итоге, постоянный запуск скрипта стабилизации рано или поздно приведет Deckhouse к состоянию, при котором тег его Docker-образа будет соответствовать заданному каналу обновлений.
 </details>
