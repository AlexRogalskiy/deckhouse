#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
   configVersion: v1
   kubernetes:
   - name: nodes
     queue: /modules/$(module::name::kebab_case)
     group: main
     apiVersion: v1
     kind: Node
     jqFilter: '.metadata.labels'
   - name: secrets
     queue: /modules/$(module::name::kebab_case)
     group: main
     apiVersion: v1
     kind: Secret
     namespace:
       nameSelector:
         matchNames: ["d8-keepalived"]
     labelSelector:
       matchExpressions:
       - {"key": "keepalived-instance", "operator": "Exists"}
     jqFilter: '.data.authPass | @base64d'
   - name: keepalived_instances
     queue: /modules/$(module::name::kebab_case)
     group: main
     apiVersion: deckhouse.io/v1alpha1
     kind: KeepalivedInstance
EOF
}

function __main__() {
  if context::jq -e '([.snapshots.keepalived_instances[] | .object.spec.vrrpInstances[] | .id] | unique | length) != ([.snapshots.keepalived_instances[] | .object.spec.vrrpInstances[] | .id] | length)'; then
    echo "KeepalivedInstances handler ERROR: All vrrpInstances[].id in all KeepalivedInstances must be unique cluster-wide."
    exit 1
  fi

  instances="$(context::jq -r '[.snapshots.keepalived_instances[].object | {(.metadata.name): .spec}] | reduce .[] as $i ({}; . * $i)')"
  values::set keepalived.instances "${instances}"

  for instanceName in $(jq -r '. | keys[]' <<< ${instances}); do
    nodeSelector=$(jq -r ".\"${instanceName}\".nodeSelector" <<< "$instances")
    replicas=$(context::jq -r "[.snapshots.nodes[] | select(.object.metadata.labels | contains(${nodeSelector}))] | length")
    values::set keepalived.instances."${instanceName}".replicas $replicas
  done

  for instance in $(jq -nr --argjson a "${instances}" '$a | to_entries[] | .key'); do
    if authPass=$(context::jq --arg instance "$instance" -re '.snapshots.secrets[] | select(.object.metadata.labels."keepalived-instance" == $instance) | .filterResult'); then
      values::set keepalived.instances."${instance}".authPass "$authPass"
    else
      values::set keepalived.instances."${instance}".authPass $(tools::generate_password | cut -c -8)
    fi
  done
}

hook::run "$@"
