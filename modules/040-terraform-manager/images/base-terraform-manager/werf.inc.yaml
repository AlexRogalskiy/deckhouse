---
artifact: candictl
from: {{ env "BASE_GOLANG_ALPINE" }}
git:
- add: /candictl
  to: /candictl
  stageDependencies:
    install:
    - go.mod
    - go.sum
    setup:
    - "**/*.go"
    - hack/build.sh
ansible:
  beforeInstall:
  - apk:
      name: git,ca-certificates
      update_cache: yes
  - command: rm -rf /var/cache/apk/*

  install:
  - shell: go mod download
    args:
      chdir: /candictl

  setup:
  - command: /candictl/hack/build.sh
    args:
      chdir: /candictl/hack
---
image: {{ .ModuleName }}/{{ .ImageName }}
from: {{ env "BASE_ALPINE" }}
docker:
  ENTRYPOINT: ["candictl"]
import:
- artifact: candictl
  add: /candictl/hack/candictl
  to: /usr/bin/candictl
  before: setup
git:
- add: /
  to: /deckhouse
  includePaths:
  - candi
ansible:
  install:
  - name: "Install terraform"
    unarchive:
      src: https://releases.hashicorp.com/terraform/{{ env "TF_VERSION" }}/terraform_{{ env "TF_VERSION" }}_linux_amd64.zip
      remote_src: yes
      dest: /bin
      mode: +x
  - command: rm -rf /var/cache/apk/*
  setup:
  - name: "Configure terraform cli"
    copy:
      dest: "/root/.terraformrc"
      content: |
        provider_installation {
          filesystem_mirror {
            path    = "/usr/local/share/terraform/plugins"
            include = ["*/*/*"]
          }
        }
