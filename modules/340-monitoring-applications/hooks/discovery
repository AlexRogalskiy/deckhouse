#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    beforeHelm: 10
    kubernetes:
    - name: services_old
      group: main
      keepFullObjectsInMemory: false
      apiVersion: v1
      kind: Service
      labelSelector:
        matchExpressions:
        - key: prometheus-target
          operator: Exists
      jqFilter: .metadata.labels."prometheus-target"
    - name: services
      group: main
      keepFullObjectsInMemory: false
      apiVersion: v1
      kind: Service
      labelSelector:
        matchExpressions:
        - key: prometheus.deckhouse.io/target
          operator: Exists
      jqFilter: .metadata.labels."prometheus.deckhouse.io/target"
EOF
}

function __main__() {
  enabledApplications=$(context::jq -r '[.snapshots.services_old + .snapshots.services | .[] | .filterResult] | sort | unique')
  values::set monitoringApplications.discovery.enabledApplications "$enabledApplications"
}

function __on_before_helm() {
  enabledApplicationsSummary=$(values::jq -r '.monitoringApplications.discovery.enabledApplications + .monitoringApplications.enabledApplications | unique')
  values::set monitoringApplications.internal.enabledApplicationsSummary "${enabledApplicationsSummary}"
}

hook::run $@
