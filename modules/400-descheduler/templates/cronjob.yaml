---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: descheduler
  namespace: d8-descheduler
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 6
  failedJobsHistoryLimit: 6
  jobTemplate:
    spec:
      parallelism: 1
      completions: 1
      template:
        spec:
          restartPolicy: Never
          serviceAccountName: descheduler
          imagePullSecrets:
          - name: deckhouse-registry
{{- include "helm_lib_node_selector" (tuple . "system") | indent 10 }}
{{- include "helm_lib_tolerations" (tuple . "system") | indent 10 }}
          {{- if semverCompare ">=1.11" .Values.global.discovery.clusterVersion }}
          priorityClassName: cluster-low
          {{- end }}
          containers:
          - name: descheduler
            image: {{ $.Values.global.modulesImages.registry }}/descheduler/descheduler:{{ $.Values.global.modulesImages.tags.descheduler.descheduler }}
            volumeMounts:
            - mountPath: /policy
              name: policy-volume
            command:
            - "/bin/descheduler"
            args:
            - "--policy-config-file"
            - "/policy/policy.yaml"
            - "--v"
            - "6"
          volumes:
          - name: policy-volume
            configMap:
              name: descheduler-policy-configmap
