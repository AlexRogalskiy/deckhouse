---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: descheduler
  namespace: d8-descheduler
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 6
  failedJobsHistoryLimit: 6
  jobTemplate:
    spec:
      parallelism: 1
      completions: 1
      template:
        spec:
          restartPolicy: Never
          serviceAccountName: descheduler
          imagePullSecrets:
          - name: deckhouse-registry
{{- include "helm_lib_node_selector" (tuple . "system") | indent 10 }}
{{- include "helm_lib_tolerations" (tuple . "system") | indent 10 }}
{{- include "helm_lib_priority_class" (tuple . "cluster-low") | indent 10 }}
{{- include "helm_lib_module_pod_security_context_run_as_user_nobody" . | indent 10 }}
          containers:
          - name: descheduler
{{- include "helm_lib_module_container_security_context_read_only_root_filesystem" . | indent 12 }}
            image: {{ $.Values.global.modulesImages.registry }}/descheduler/descheduler:{{ $.Values.global.modulesImages.tags.descheduler.descheduler }}
            volumeMounts:
            - mountPath: /policy
              name: policy-volume
            command:
            - "/bin/descheduler"
            args:
            - "--policy-config-file"
            - "/policy/policy.yaml"
            - "--v"
            - "6"
            resources:
              requests:
{{- include "helm_lib_module_ephemeral_storage_only_logs" . | indent 16 }}
          volumes:
          - name: policy-volume
            configMap:
              name: descheduler-policy-configmap
