- name: d8.nginx_ingress
  rules:
  - alert: D8NginxIngressRewriteTargetMigrationEnabled
    expr: max(d8_nginx_ingress_rewrite_target_migration_enabled) > 0
    labels:
      severity_level: "9"
      d8_module: nginx_ingress
      d8_component: ingress-conversion-webhook
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_incident_initial_status: "todo"
      description: |
        The rewriteTargetMigration parameter is enabled for the old nginx-ingress module in the cluster. It is responsible for creating `rwr` Ingresses.

        This parameter was designed to migrate from older versions of Ingress resources to newer ones.
        You have to disable this parameter in the cluster. To do that:
        1. Replace the `ingress.kubernetes.io` annotation with `nginx.ingress.kubernetes.io` for all client `Ingress` resources.
        2. If client `Ingress` resources use the `nginx.ingress.kubernetes.io/rewrite-target` annotation, you have to modify its format as described in the `Ingress` resource with the `-rwr` postfix and add the `nginx.ingress.kubernetes.io/use-regex` annotation
        3. Re-deploy all the updated `Ingress` resources
        4. Coordinate with the client the time to re-deploy all the Ingress controllers since disabling this option will result in all ingress controllers being re-deployed simultaneously.
        5. If you use a new `ingress-nginx` module in the cluster, then you need to edit the `IngressNginxController` custom resource and remove the `rwr` postfix for `ingressClass` after reconfiguring all the resources and before disabling this flag.
      summary: |
        The rewriteTargetMigration parameter is enabled for the old nginx-ingress module in the cluster.
