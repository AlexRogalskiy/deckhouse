#!/bin/bash

# Copyright 2021 Flant CJSC
# Licensed under the Deckhouse Platform Enterprise Edition (EE) license. See https://github.com/deckhouse/deckhouse/ee/LICENSE


source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    beforeHelm: 0
    schedule:
    - name: madison_backends_discovery
      queue: /modules/$(module::name::kebab_case)/madison_backends_discovery
      crontab: "*/10 * * * *"
      allowFailure: true
EOF
}

function __main__() {
  if ! values::is_false prometheusMadisonIntegration.madisonSelfSetupKey ; then
    backends=$(getent ahosts madison-direct.flant.com | grep STREAM | awk {'print $1'} | sort | jo -a)
    values::set prometheusMadisonIntegration.internal.madisonBackends "$backends"
  elif values::has prometheusMadisonIntegration.internal.madisonBackends ; then
    values::unset prometheusMadisonIntegration.internal.madisonBackends
  fi
}

hook::run "$@"
