{{ $BASE_GOLANG := "golang:1.15.3-buster@sha256:fb04edf20446eed8af9eb6137d02fdf607f47028a0a806131f8b175a09620aab" }}
{{ $BASE_DEBIAN := "debian:buster-20210111@sha256:b16f66714660c4b3ea14d273ad8c35079b81b35d65d1e206072d226c7ff78299" }}

project: deckhouse-web
configVersion: 1

---
artifact: web-static
from: jekyll/builder:3.8
fromCacheVersion: 20210702
ansible:
  install:
    - shell: |
        apk add rsync
        gem update bundler
    - name: "Install Dependencies"
      shell: bundle install
      args:
        executable: /bin/bash
        chdir: /srv/jekyll-data/site/
  beforeSetup:
    - name: "Build static files"
      shell: |
        export JEKYLL_ENV=production
        mkdir -m 777 -p /app/_site/
        jekyll build -d /app/_site/ --config _config.yml --trace
      args:
        executable: /bin/bash
        chdir: /srv/jekyll-data/site/
git:
- add: /docs/site
  to: /srv/jekyll-data/site
  owner: jekyll
  group: jekyll
  excludePaths:
  - '**/*.sh'
  - werf*.yaml
  - docker-compose*.yml
  - .werf
  - .helm
  - backend
  stageDependencies:
    install: ['Gemfile','Gemfile.lock']
    beforeSetup: '**/*'
---
image: web-backend
from: {{ $BASE_GOLANG }}
fromCacheVersion: 20210701
docker:
  WORKDIR: /app
ansible:
  install:
    - shell: apt update && apt install -yq git curl jq
    - shell: |
        go get -d -v ./
        go get github.com/go-delve/delve/cmd/dlv
  setup:
    - shell: |
        go build -gcflags "all=-N -l" -v -o /app/server /app/
      args:
        executable: /bin/bash
        chdir: /app
git:
  - add: /docs/site/backend
    to: /app
    stageDependencies:
      setup: '**/*'
import:
  - artifact: web-static
    add: /app/_site
    to: /app/root
    before: setup
