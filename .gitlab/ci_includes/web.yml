Main web build:
  stage: build
  variables:
    WERF_DIR: "docs/site"
    WERF_STAGES_STORAGE: "${WERF_STAGES_REPO_BASE}/stages-web"
    WERF_LOG_VERBOSE: "on"
    WERF_LOOSE_GITERMINISM: "true"
  script:
  - type multiwerf && source $(multiwerf use 1.2 ${WERF_CHANNEL}  --as-file)
  - type werf && source $(werf ci-env gitlab --verbose --as-file)
  - werf build
  except:
  - schedules
  - alpha
  - beta
  - early-access
  - stable
  - rock-solid
  tags:
  - werf-distributed
  interruptible: true

Doc web build:
  stage: build
  variables:
    WERF_DIR: "docs/documentation"
    WERF_STAGES_STORAGE: "${WERF_STAGES_REPO_BASE}/stages-web"
    WERF_LOG_VERBOSE: "on"
  script:
  - type multiwerf && source $(multiwerf use 1.2 ${WERF_CHANNEL}  --as-file)
  - type werf && source $(werf ci-env gitlab --verbose --as-file)
  - werf build
  except:
  - schedules
  - alpha
  - beta
  - early-access
  - stable
  - rock-solid
  tags:
  - werf-distributed
  interruptible: true

Web links test:
  before_script:
  - export WERF_STAGES_STORAGE=${WERF_STAGES_REPO_BASE}/stages-web
  extends: .Web links test
  tags:
  - werf-distributed

.web_base_deploy: &web_base_deploy
  stage: deploy_website
  before_script:
  - export WERF_NAMESPACE=${WERF_NAMESPACE:-deckhouse-${CI_ENVIRONMENT_SLUG}}
  - export WERF_STAGES_STORAGE=${WERF_STAGES_REPO_BASE}/stages-web
  script:
  - type multiwerf && source $(multiwerf use 1.2 alpha --as-file)
  - type werf && source $(werf ci-env gitlab --verbose --as-file)
  - werf converge
    --set "global.url=$(cut -d / -f 3 <<< $CI_ENVIRONMENT_URL)"
    --set "global.env=${CI_ENVIRONMENT_SLUG}"
  needs:
  - "Build"
  - "Doc web build"
  - "Main web build"
  - "Web links test"
  except:
  - schedules
  - alpha
  - beta
  - early-access
  - stable
  - rock-solid
  tags:
  - werf-distributed

(Test) Main Deploy:
  <<: *web_base_deploy
  variables:
    WERF_KUBECONFIG_BASE64: "${KUBECONFIG_BASE64_DEV}"
    WERF_DIR: "docs/site"
    WERF_RELEASE: "deckhouse-site"
    WERF_SET_DOC_VERSION: "global.doc_version=v1.2.3-dev"
    WERF_SET_ACTIVE_RELEASE: "global.active_release=v1"
  environment:
    name: web-test
    url: https://deckhouse.test.flant.com
  when: manual

(Test) Doc Deploy :
  <<: *web_base_deploy
  variables:
    WERF_KUBECONFIG_BASE64: "${KUBECONFIG_BASE64_DEV}"
    WERF_DIR: "docs/documentation"
    WERF_RELEASE: "deckhouse-doc"
    WERF_SET_DOC_VERSION: "global.doc_version=v1.2.3-dev"
  environment:
    name: web-test
    url: https://deckhouse.test.flant.com
  when: manual

early.deckhouse.io:
  <<: *web_base_deploy
  variables:
    WERF_KUBECONFIG_BASE64: "${KUBECONFIG_BASE64_PROD}"
  environment:
    name: web-early
    url: https://early.deckhouse.io
  when: manual

deckhouse.io:
  <<: *web_base_deploy
  variables:
    WERF_KUBECONFIG_BASE64: "${KUBECONFIG_BASE64_PROD}"
  environment:
    name: web-production
    url: https://deckhouse.io
  only:
    - master
    - /^release-.*$/
  when: manual

Web cleanup:
  stage: cleanup_registry
  variables:
    WERF_DIR: "docs/site"
    WERF_STAGES_STORAGE: "${WERF_STAGES_REPO_BASE}/stages-web"
  script:
  - type multiwerf && source $(multiwerf use 1.2 ${WERF_CHANNEL} --as-file)
  - type werf && source $(werf ci-env gitlab --verbose --as-file)
  - docker login -u nobody -p ${REGISTRY_CLEANER_TOKEN} ${CI_REGISTRY_IMAGE}
  - werf cleanup
  only:
    refs:
    - schedules
    variables:
    - $CLEANUP_SCHEDULE
  tags:
  - werf-distributed
