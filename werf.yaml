project: deckhouse
configVersion: 1
---
image: ~
from: alpine:3.9
git:
- add: /
  to: /deckhouse
  includePaths:
  - modules
  - global-hooks
  - shell_lib.sh
  - entrypoint.sh
  - shell_lib
  - jq_lib
  - helm_lib
  excludePaths:
  - modules/*/images
  - modules/*/docs
  - modules/*/README.md
import:
- artifact: deckhouse
  add: /deckhouse/deckhouse
  to: /deckhouse/deckhouse-controller
  before: setup
- artifact: unit-converter
  add: /unit-converter/unit-converter
  to: /usr/local/bin/unit-converter
  before: setup
- artifact: vsphere-cli-helper
  add: /vsphere-cli-helper/vsphere-cli-helper
  to: /usr/local/bin/vsphere-cli-helper
  before: setup
- artifact: fnv-encoder
  add: /fnv-encoder/fnv-encoder
  to: /usr/local/bin/fnv-encoder
  before: setup
- artifact: aws-cli-helper
  add: /aws-cli-helper/aws-cli-helper
  to: /usr/local/bin/aws-cli-helper
  before: setup
ansible:
  beforeInstall:
  - apk: update_cache=yes

  - name: "Install dependencies"
    apk:
      name:
      # Нам нужен bash, на нем все хуки
      - bash
      - bash-completion
      - jq
      - curl
      - pwgen
      - apache2-utils
      - bc
      - grep
      - tar
      - unzip
      - coreutils
      - util-linux

  # Зависимости хуков (из edge/testing)
  - apk: name=jo repository=http://nl.alpinelinux.org/alpine/edge/testing/ update_cache=yes
  - apk: name=cfssl repository=http://nl.alpinelinux.org/alpine/edge/testing/
  - apk: name=rgxg repository=http://nl.alpinelinux.org/alpine/edge/testing/

  # Ставим kubectl
  - name: "Install kubectl"
    get_url:
      url: https://storage.googleapis.com/kubernetes-release/release/v1.11.9/bin/linux/amd64/kubectl
      dest: /usr/local/bin/kubectl
      mode: +x

  - name: Install yq
    get_url:
      url: https://github.com/mikefarah/yq/releases/download/2.4.0/yq_linux_amd64
      dest: /usr/local/bin/yq
      mode: +x

  # Ставим semver
  - name: "Install semver"
    unarchive:
      extra_opts:
      - semver-tool-2.1.0/src
      - --strip-components=2
      src: https://github.com/fsaintjacques/semver-tool/archive/2.1.0.tar.gz
      remote_src: yes
      dest: /usr/local/bin

  # ca-certificates нужны для работы helm
  - apk: name=ca-certificates

  # Ставим helm
  - name: "Install helm"
    unarchive:
      extra_opts:
      - linux-amd64/helm
      - --strip-components=1
      src: https://storage.googleapis.com/kubernetes-helm/helm-v2.14.1-linux-amd64.tar.gz
      remote_src: yes
      dest: /usr/local/bin
  - raw: helm init --client-only
  # Ставим tiller
  - name: "Install tiller"
    unarchive:
      extra_opts:
      - linux-amd64/tiller
      - --strip-components=1
      src: https://storage.googleapis.com/kubernetes-helm/helm-v2.14.1-linux-amd64.tar.gz
      remote_src: yes
      dest: /bin

  - name: "Install registry client"
    get_url:
      url: https://github.com/genuinetools/reg/releases/download/v0.16.0/reg-linux-amd64
      dest: /usr/local/bin/reg
      mode: +x
      checksum: sha256:0470b6707ac68fa89d0cd92c83df5932c9822df7176fcf02d131d75f74a36a19

    # Чистим кеш
  - raw: rm -rf /var/cache/apk/*

  setup:
  - name: "Add modules images tags.json"
    copy:
      content: |
{{ .Files.Get "modules/images_tags.json" | indent 8 }}
      dest: /deckhouse/modules/images_tags.json
  - name: "Shell comfort: inputrc"
    copy:
      content: |
{{ .Files.Get "deckhouse/files/inputrc" | indent 8 }}
      dest: /etc/inputrc
  - name: "Shell comfort: bashrc"
    copy:
      content: |
{{ .Files.Get "deckhouse/files/bashrc" | indent 8 }}
      dest: /root/.bashrc
  - name: "Shell comfort: vimrc"
    copy:
      content: |
{{ .Files.Get "deckhouse/files/vimrc" | indent 8 }}
      dest: /root/.vimrc
  - name: "Shell comfort: kubectl completion"
    shell: kubectl completion bash > /root/.kubectl_completion.sh

  # Because of https://github.com/flant/werf/issues/1741 just move the entry point
  - name: "Move deckhouse entrypoint to the right location"
    shell: mv /deckhouse/entrypoint.sh /deckhouse/deckhouse

  # Миграция 2019-10-14: Удалить копирование в директорию antiopa после выката версии на все инстансы
  - name: "Antiopa to Deckhouse migration"
    shell: mkdir /antiopa/ && ln -s /deckhouse/deckhouse /antiopa/antiopa


docker:
  ENV:
    MODULES_DIR: /deckhouse/modules
    GLOBAL_HOOKS_DIR: /deckhouse/global-hooks
---
artifact: unit-converter
from: golang:1.12-alpine3.9
git:
- add: /unit-converter
  to: /unit-converter
  stageDependencies:
    install:
    - go.mod
    - go.sum
    setup:
    - main.go
ansible:
  beforeInstall:
  - apk: name=git update_cache=yes
  - command: rm -rf /var/cache/apk/*

  install:
  - command: go get -v -d -t ./...
    args:
      chdir: /unit-converter

  setup:
  - command: go build -o unit-converter main.go
    args:
      chdir: /unit-converter
---
artifact: fnv-encoder
from: golang:1.12-alpine3.9
git:
- add: /fnv-encoder
  to: /fnv-encoder
  stageDependencies:
    setup:
    - main.go
ansible:
  setup:
  - command: go build -o fnv-encoder main.go
    args:
      chdir: /fnv-encoder
---
artifact: vsphere-cli-helper
from: golang:1.12-alpine3.9
git:
- add: /go_lib/vsphere-cli-helper
  to: /vsphere-cli-helper
  stageDependencies:
    install:
    - go.mod
    - go.sum
    setup:
    - main.go
ansible:
  beforeInstall:
  - apk: name=git update_cache=yes
  - command: rm -rf /var/cache/apk/*

  install:
  - command: go mod download
    args:
      chdir: /vsphere-cli-helper

  setup:
  - command: go build -o vsphere-cli-helper
    environment:
      CGO_ENABLED: "0"
      GOOS: "linux"
      GOARCH: "amd64"
    args:
      chdir: /vsphere-cli-helper
---
artifact: aws-cli-helper
from: golang:1.13-alpine3.10
git:
- add: /go_lib/aws-cli-helper
  to: /aws-cli-helper
  stageDependencies:
    install:
    - go.mod
    - go.sum
    setup:
    - main.go
ansible:
  beforeInstall:
  - apk: name=git update_cache=yes
  - command: rm -rf /var/cache/apk/*

  install:
  - command: go mod download
    args:
      chdir: /aws-cli-helper

  setup:
  - command: go build -o aws-cli-helper
    environment:
      CGO_ENABLED: "0"
      GOOS: "linux"
      GOARCH: "amd64"
    args:
      chdir: /aws-cli-helper
---
artifact: deckhouse
from: golang:1.12-alpine3.9
git:
- add: /deckhouse
  to: /deckhouse
  excludePaths:
  - development
  stageDependencies:
    install:
    - go.mod
    - go.sum
    setup:
    - "**/*.go"
    - go-build.sh
ansible:
  beforeInstall:
  - apk: name=git update_cache=yes
  - command: rm -rf /var/cache/apk/*

  install:
  - shell: go mod download
    args:
      chdir: /deckhouse

  setup:
  - command: /deckhouse/go-build.sh
    args:
      chdir: /deckhouse
