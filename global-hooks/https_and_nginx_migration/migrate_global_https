#!/bin/bash

### Миграция 2019-08-02: https://github.com/deckhouse/deckhouse/merge_requests/978
#
# Этот хук можно удалить, после выката данного MR'а на все инсталяции.

source /antiopa/shell_lib.sh

function __config__() {
  jo -p onStartup=1
}

function __main__() {
  if values::has --config global.certificateForIngress ; then
    if ! values::has --config global.modules ; then
      values::set --config global.modules "{}"
    fi

    values::set --config global.modules.https "{}"

    if values::has --config global.certificateForIngress.certmanagerClusterIssuerName && values::is_false --config global.certificateForIngress.certmanagerClusterIssuerName && values::has --config global.certificateForIngress.customCertificateSecretName && values::is_false --config global.certificateForIngress.customCertificateSecretName ; then
      values::set --config global.modules.https.mode "Disabled"
    elif values::has --config global.certificateForIngress.certmanagerClusterIssuerName && values::is_false --config global.certificateForIngress.certmanagerClusterIssuerName && ! values::has --config global.certificateForIngress.customCertificateSecretName ; then
      values::set --config global.modules.https.mode "Disabled"
    elif values::has --config global.certificateForIngress.certmanagerClusterIssuerName && ! values::is_false --config global.certificateForIngress.certmanagerClusterIssuerName ; then
      values::set --config global.modules.https.certManager "{}"
      values::set --config global.modules.https.certManager.clusterIssuerName "$(values::get --config global.certificateForIngress.certmanagerClusterIssuerName)"
      values::set --config global.modules.https.mode "CertManager"
    elif values::has --config global.certificateForIngress.customCertificateSecretName && ! values::is_false --config global.certificateForIngress.customCertificateSecretName ; then
      values::set --config global.modules.https.customCertificate "{}"
      values::set --config global.modules.https.customCertificate.secretName "$(values::get --config global.certificateForIngress.customCertificateSecretName)"
      values::set --config global.modules.https.mode "CustomCertificate"
    fi

    values::unset --config global.certificateForIngress
  fi
}

hook::run $@
