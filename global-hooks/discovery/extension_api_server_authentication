#!/bin/bash

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    kubernetes:
    - name: extension_api_server_authentication
      includeSnapshotsFrom: ["extension_api_server_authentication"]
      apiVersion: v1
      kind: ConfigMap
      namespace:
        nameSelector:
          matchNames: [kube-system]
      nameSelector:
        matchNames: [extension-apiserver-authentication]
      jqFilter: '.data."requestheader-client-ca-file"'
EOF
}

function __on_kubernetes::extension_api_server_authentication() {
  values::set global.discovery.extensionAPIServerAuthenticationRequestheaderClientCA "$(context::get snapshots.extension_api_server_authentication.0.filterResult)"
}

hook::run "$@"
