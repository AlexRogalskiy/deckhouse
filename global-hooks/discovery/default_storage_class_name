#!/bin/bash
# TODO: need SyncAll mode
source /deckhouse/shell_lib.sh

function __config__() {
  yq r -j - << EOF
    configVersion: v1
    kubernetes:
    - apiVersion: storage.k8s.io/v1
      kind: Storageclass
      jqFilter: '[.metadata.annotations."storageclass.beta.kubernetes.io/is-default-class", .metadata.annotations."storageclass.kubernetes.io/is-default-class", .metadata.name]'
EOF
}

function __main__() {
  if default_storage_class=$(kubectl get storageclass -o json | jq '.items[] | select ((.metadata.annotations."storageclass.beta.kubernetes.io/is-default-class" == "true") or (.metadata.annotations."storageclass.kubernetes.io/is-default-class" == "true")) | .metadata.name' -r | head -n 1) && [[ -n "$default_storage_class" ]] ; then
    values::set global.discovery.defaultStorageClass $default_storage_class
  else
    values::unset global.discovery.defaultStorageClass
  fi
}

hook::run_ng $@
