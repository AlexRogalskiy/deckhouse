#!/bin/bash

# Hook detects if control plane in the cluster configured as HA
# If there are more than one replicas of apiserver, someone has cared about it. It means that our cluster
# needs High Availability, for example, in modules.
# (Read more about global.highAvailability in /README.md).

source /deckhouse/shell_lib.sh

function __config__() {
  yq r -j - << EOF
    configVersion: v1
    kubernetes:
    - name: kube-api-ep
      apiVersion: v1
      kind: Endpoints
      namespace:
        nameSelector:
          matchNames: [default]
      nameSelector:
        matchNames: [kubernetes]
      jqFilter: '.subsets[].addresses | length'
EOF
}

function _handle_num_apiservers() {
  num_apiservers=$1
  values::set global.discovery.clusterMasterCount "$num_apiservers"
  if [ $num_apiservers -gt 1 ]; then
    values::set global.discovery.clusterControlPlaneIsHighlyAvailable true
  else
    values::set global.discovery.clusterControlPlaneIsHighlyAvailable false
  fi
}

function __on_kubernetes::synchronization::kube-api-ep() {
  _handle_num_apiservers "$(jq -r '.[0]' <<< ${1})"
}

function __on_kubernetes::added_or_modified::kube-api-ep() {
  _handle_num_apiservers "${1}"
}

hook::run_ng $@
