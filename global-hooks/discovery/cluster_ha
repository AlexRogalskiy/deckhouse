#!/bin/bash

# Hook detects if control plane in the cluster configured as HA
# If there are more than one replicas of apiserver, someone has cared about it. It means that our cluster
# needs High Availability, for example, in modules.
# (Read more about global.highAvailability in /README.md).

source /deckhouse/shell_lib.sh

function __config__() {
  cat << EOF
    configVersion: v1
    kubernetes:
    - name: kube_api_ep
      apiVersion: v1
      kind: Endpoints
      namespace:
        nameSelector:
          matchNames: [default]
      nameSelector:
        matchNames: [kubernetes]
      jqFilter: '{"clusterMasterCount": (.subsets[].addresses | length), "isHA": (.subsets[].addresses | length > 1)}'
EOF
}

function __on_kubernetes::kube_api_ep::synchronization() {
  values::set global.discovery.clusterMasterCount "$(context::get objects.0.filterResult.clusterMasterCount)"
  values::set global.discovery.clusterControlPlaneIsHighlyAvailable "$(context::get objects.0.filterResult.isHA)"
}

function __on_kubernetes::kube_api_ep::added_or_modified() {
  values::set global.discovery.clusterMasterCount "$(context::get filterResult.clusterMasterCount)"
  values::set global.discovery.clusterControlPlaneIsHighlyAvailable "$(context::get filterResult.isHA)"
}

hook::run $@
