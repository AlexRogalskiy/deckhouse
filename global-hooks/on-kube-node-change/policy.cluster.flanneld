#!/bin/bash

source /antiopa/shell_lib.sh

# flannel есть только в Manual кластерах
[[ $(cluster::type) != "Manual" ]] && exit

fltr='.'

###
# Политика #1: flanneld должен быть запущен на всех узлах, вне зависимости от taint'ов
fltr=$fltr' | .spec.template.spec.tolerations = [{"operator":"Exists"}]'

###
# Политика #2: DaemonSet flanneld должен нормально обновляться
fltr=$fltr' | .spec.updateStrategy.type = "RollingUpdate"'

# Применяем
kubectl::apply_jq kube-system ds/kube-flannel-ds "$fltr"
