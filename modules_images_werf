#!/bin/bash

set -o pipefail
set -e

function bp() {
  # Set env DECKHOUSE_PULL_MODULES_IMAGES_BEFORE_BUILD=true to pull every image used in modules
  if [[  "$DECKHOUSE_PULL_BASE_IMAGES_BEFORE_BUILD_MODULES" == "true" ]]; then
    pull
  fi

  werf build-and-publish --config modules_images_werf.yaml --publish-report-path images_tags_werf.json

  jq '
    def to_camel_case:
      . | ascii_downcase | split("-") | .[0:1] as $first | .[1:] |
      map(
        .[1:] as $rest | .[0:1] | ascii_upcase | . + $rest
      ) |
      $first + . | join("")
    ;
    .Images | to_entries | reduce .[] as $image ({};
      . * {
        ($image.key | split("/")[0] | to_camel_case): {
          ($image.key | split("/")[1] | to_camel_case): $image.value.DockerTag
        }
      }
    )' images_tags_werf.json > modules/images_tags.json

  rm images_tags_werf.json
}

function cleanup() {
  docker login -u nobody -p ${REGISTRY_CLEANER_TOKEN} ${CI_REGISTRY_IMAGE}
  werf cleanup --config modules_images_werf.yaml --without-kube
}

function test_web_links() {
  set +e
  IMAGE_URL="${CI_REGISTRY_IMAGE}/deckhouse-web/web:$(jq .deckhouseWeb.web -r modules/images_tags.json)"
  REPORT_FILE=${REPORT_FILE:-link_test_report.txt}
  docker pull ${IMAGE_URL}
  (docker run --rm --entrypoint cat $IMAGE_URL /usr/share/nginx/html/link_test_report.txt) &> ${REPORT_FILE}
  echo -e "\n#################################################\nThe deckhouse-web module link checking report:\n"
  cat ${REPORT_FILE}
  cat ${REPORT_FILE} | grep -Eq 'finished successfully.$'
  if [ $? -ne 0 ]; then
    exit 1
  fi
}

function pull() {
  >&2 echo "Pulling images..."
  cat $(find modules -name *Dockerfile -o -name *werf.inc.yaml) \
    | grep -Eo '^(from\:|FROM)\s(\S+)$' \
    | cut -d ' ' -f2 | tr -d \" \
    | sort | uniq \
    | xargs --no-run-if-empty -n 1 docker pull -q
}

! read -rd '' HELP_STRING <<"EOF"
Usage: modules_images SUBCOMMAND [SUBCOMMAND OPTIONS]...

Available subcommands: (for details, modules_images SUBCOMMAND --help)

modules_images bp
modules_images cleanup
modules_images test_web_links
modules_images pull
EOF

type jq &>/dev/null || (echo "Please install jq (https://stedolan.github.io/jq/)"; exit 1)

if [[ $# -eq 0 ]] ; then
  echo "$HELP_STRING"
  exit 1
fi

SUBCOMMAND=$1
shift

type multiwerf && source <(multiwerf use 1.1 alpha)
type werf && source <(werf ci-env gitlab --verbose)

case "$SUBCOMMAND" in
  bp )
    bp $@ ;;
  cleanup )
    cleanup $@ ;;
  test_web_links )
    test_web_links $@ ;;
  pull )
    pull $@ ;;
  * )
    echo "$HELP_STRING"; exit 1 ;;
esac
