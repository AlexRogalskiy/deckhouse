dimg_group do
  artifact do
    docker.from 'golang:1.8-alpine3.6'

    git do
      add '/' do
        to '/go/src/github.com/deckhouse/deckhouse'
        exclude_paths 'playground', 'play-registry'
        # go get будет вызывать только если изменился этот файл!
        stage_dependencies.install 'go-get-run'
        # **/*.go срабатывает от изменений в modules
        # **.go и *.go не срабатывают от изменений *.go во вложенных директориях
        # Пока вложенные нужно придётся добавлять отдельно: stage_dependencies.build_artifact 'play-values/*.go'
        stage_dependencies.build_artifact '*.go'
      end
    end

    shell.before_install do
      run 'apk update'
      run 'apk add git'
      run 'rm -rf /var/cache/apk/*'
    end

    shell.install do
      run '(go get -v -d github.com/deckhouse/deckhouse/... ; true)'
    end

    shell.build_artifact do
      run 'cd /go/src/github.com/deckhouse/deckhouse'
      run 'go build'
    end

    export '/go/src/github.com/deckhouse/deckhouse/antiopa' do
      to '/antiopa/antiopa'
      before 'setup'
    end
  end

  dimg do
    docker.from 'alpine:3.6'

    git do
      add '/' do
        to '/antiopa'
        include_paths 'modules', 'global-hooks', 'shell-lib', 'shell-lib.d', '.kube-api'
      end
    end

    shell.before_install do
      run 'apk update'

      # Нам нужны kubectl и helm
      run 'apk add curl'
      run 'curl -Ls https://storage.googleapis.com/kubernetes-release/release/v1.8.8/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl'
      run 'chmod +x /usr/local/bin/kubectl'
      run 'curl -Ls https://storage.googleapis.com/kubernetes-helm/helm-v2.6.2-linux-amd64.tar.gz | tar zx linux-amd64/helm -O > /usr/local/bin/helm'
      run 'chmod +x /usr/local/bin/helm'
      run 'apk del curl'

      # ca-certificates нужны для работы helm
      run 'apk add ca-certificates'

      # Нам нужен bash, на нем все хуки
      run 'apk add bash'

      # Зависимости хуков
      run 'apk add jq makepasswd apache2-utils'

      run 'rm -rf /var/cache/apk/*'
    end
  end
end
