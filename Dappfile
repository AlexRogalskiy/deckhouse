dimg_group do

  shell.before_install do
    run 'apt-get update',
        'apt-get -q -y install git openssl apt-transport-https ca-certificates curl g++ gcc libc6-dev make python3 pkg-config libssl-dev cmake'

    run 'cd',
        'curl -fsSL https://github.com/libssh2/libssh2/archive/libssh2-1.7.0.tar.gz -o libssh2.tar.gz',
        'mkdir libgit2',
        'tar xvf libssh2.tar.gz -C libgit2',
        'ls -la libgit2',
        'cd libgit2/libssh2-libssh2-1.7.0',
        'cmake -DBUILD_SHARED_LIBS=ON .',
        'cmake --build .',
        'make',
        'make install',
        'ldconfig'

    run 'cd',
        'curl -fsSL https://github.com/libgit2/libgit2/archive/v0.24.1.tar.gz -o v0.24.1.tar.gz',
        'tar xvf v0.24.1.tar.gz -C libgit2',
        'cd libgit2/libgit2-0.24.1',
        'cmake -DCURL=OFF .',
        'cmake --build .',
        'make',
        'make install',
        'ldconfig'

    run 'rm -rf ~/libgit2'
  end

  artifact do
    docker.from 'golang:1.8'

    git do
      add '/' do
        to '/go/src/github.com/deckhouse/deckhouse'
        exclude_paths 'playground', 'play-git'
        stage_dependencies.install '**/*.go'
      end
    end

    shell.install do
      run '(go get -v -d github.com/deckhouse/deckhouse/... ; true)'
    end

    shell.build_artifact do
      run 'cd /go/src/github.com/deckhouse/deckhouse'
      run 'go test'
      run 'go build'
    end

    export '/go/src/github.com/deckhouse/deckhouse/antiopa' do
      to '/antiopa'
      before 'install'
    end
  end

  dimg do
    docker.from 'ubuntu:16.04'

    shell.before_install do
      run 'apt-get -y install iproute2 tcpdump nmap jq apache2-utils'
      run 'curl -L https://raw.githubusercontent.com/micha/resty/master/resty > /usr/bin/resty'
      run 'chmod +x /usr/bin/resty'
      run 'echo "export TERM=xterm" >> /etc/bash.bashrc'

      run 'curl -L https://storage.googleapis.com/kubernetes-release/release/v1.7.7/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl'
      run 'chmod +x /usr/local/bin/kubectl'
    end

    shell.install do
      run 'curl -LOs https://storage.googleapis.com/golang/go1.8.4.linux-amd64.tar.gz'
      run 'tar -C /usr/local -xzf go1.8.4.linux-amd64.tar.gz'
      run 'echo "export PATH=\$PATH:/usr/local/go/bin" >> /etc/profile'
      run 'echo "export GOPATH=/app" >> /etc/profile'
    end

    shell.setup do
      run 'cp /kube_api/kube_api.sh /usr/bin/kube_api'
      run 'chmod +x /usr/bin/kube_api'
    end

    git do
      add '/.kube_api' do
        to '/kube_api'
      end
      add '/' do
        to '/app/src/github.com/deckhouse/deckhouse'
      end
    end

  end

end
