dimg do
  docker.from 'ubuntu:16.04'

  artifact do
    docker.from 'golang:1.8'

    git do
      add '/' do
        to '/go/src/github.com/deckhouse/deckhouse'
        exclude_paths 'playground', 'play-git'
        stage_dependencies.install '**/*.go'
      end
    end

    shell.install do
      run '(go get -v -d github.com/deckhouse/deckhouse/... ; true)'
    end

    shell.build_artifact do
      run 'cd /go/src/github.com/deckhouse/deckhouse'
      run 'go test'
      run 'go build'
    end

    export '/go/src/github.com/deckhouse/deckhouse/antiopa' do
      to '/antiopa'
      before 'install'
    end
  end

  shell.before_install do
    run 'apt-get -y update'
    run 'apt-get -y install iproute2 tcpdump nmap git curl jq python3'
    run 'curl -L https://raw.githubusercontent.com/micha/resty/master/resty > /usr/bin/resty'
    run 'chmod +x /usr/bin/resty'
    run 'echo "export TERM=xterm" >> /etc/bash.bashrc'

    run 'curl -L https://storage.googleapis.com/kubernetes-release/release/v1.7.7/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl'
    run 'chmod +x /usr/local/bin/kubectl'
  end

  shell.setup do
    run 'cp /kube_api/kube_api.sh /usr/bin/kube_api'
    run 'chmod +x /usr/bin/kube_api'
  end

  git do
    add '/.kube_api' do
      to '/kube_api'
    end
  end

end
